<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Nebula Graph"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@NebulaGraph"><meta name=twitter:creator content="@NebulaGraph"><meta name=twitter:domain content="nebula-graph.io"><meta name=twitter:title content="分布式图数据库 Nebula Graph 的 Index 实践"><meta property="twitter:title" content="分布式图数据库 Nebula Graph 的 Index 实践"><meta name=twitter:description content="索引是数据库系统中不可或缺的一个功能，数据库索引好比是书的目录，能加快数据库的查询速度，其实质是数据库管理系统中一个排序的数据结构。不同的数据库系统有不同的排序结构..."><meta name=og:description content="索引是数据库系统中不可或缺的一个功能，数据库索引好比是书的目录，能加快数据库的查询速度，其实质是数据库管理系统中一个排序的数据结构。不同的数据库系统有不同的排序结构..."><meta name=twitter:image content="/nebula-website/cn/posts/how-indexing-works-in-nebula-graph/Medium_hu77da18329ab588ac33432bb3b21c4f58_427124_600x0_resize_box_2.png"><meta name=og:image content="/nebula-website/cn/posts/how-indexing-works-in-nebula-graph/Medium_hu77da18329ab588ac33432bb3b21c4f58_427124_600x0_resize_box_2.png"><meta name=description content="索引是数据库系统中不可或缺的一个功能，数据库索引好比是书的目录，能加快数据库的查询速度，其实质是数据库管理系统中一个排序的数据结构。不同的数据库系统有不同的排序结构..."><meta name=generator content="Hugo 0.65.3"><title>分布式图数据库 Nebula Graph 的 Index 实践</title><link rel="shortcut icon" href=/nebula-website/favicon.ico><link rel=stylesheet href=/nebula-website/css/bootstrap.min.css type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic" rel=stylesheet type=text/css><link rel=stylesheet href=/nebula-website/font-awesome/css/font-awesome.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/creative.css type=text/css><link rel=stylesheet href=/nebula-website/css/modals.css type=text/css><link rel=stylesheet href=/nebula-website/css/animate.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/custom/index.css type=text/css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/nebula-website/js/jquery.js></script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPJVFGH');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-60523578-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-60523578-5');</script></head><body id=page-top><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPJVFGH" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><nav id=mainNav class="navbar navbar-default navbar-fixed-top"><div class=nav-popup id=nav-popup><img src=/images/popup.png><img src=/images/popup.png> Nebula Graph RC4 已发布！ <a href=https://github.com/vesoft-inc/nebula/releases/tag/v1.0.0-rc4 onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Banner Ad - RC4'})" target=_blank>快来尝鲜</a> <img src=/images/shut.png id=shut onclick=shut()></div><div class=container-fluid><div class=navbar-header><div class=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-icon=octicon-star data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></div><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class="navbar-brand page-scroll" href=/nebula-website/cn/></a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav" id=nav><li class=github-star id=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-size=large data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></li><li><a href=https://docs.nebula-graph.io/ target=_blank>文档</a></li><li class=active><a href=/cn/posts target>博客</a></li><li><a href=https://discuss.nebula-graph.com.cn/ target=_blank>论坛</a></li><li><a href=#contact_us target onclick=contactUsClick()>联系我们</a></li><li class="dropdown navbar-right"><a class=dropdown-toggle data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false><img src=/images/language120x120.png>
<span class=caret></span></a><ul class=dropdown-menu><li class=nav-item><a class=dropdown-item href=/en target>English</a></li><li class=nav-item><a class=dropdown-item href=/cn target>中文</a></li></ul></li><li id=navbar-right><a href=https://github.com/vesoft-inc/nebula-web-docker target=_blank onclick="gtag('event','Button Click',{event_category:'Engagement',event_label:'Nebula Studio'})">Nebula Studio</a></li></ul></div></div></nav><script>function contactUsClick(){$('html,body').animate({scrollTop:document.documentElement.scrollHeight},800)
return false;}
function shut(){$('#nav-popup').remove();$("#top").css("padding-top","50px")
sessionStorage.setItem("popupIsRemove",true);}
if(!sessionStorage.getItem("popupIsRemove")){$("#nav-popup").css("display","block")}</script><main id=top class=blog-detail><div class=wrapper><div class=inner><div class=blog-left-aside><div class=social-share id=J_Share><h3>分享</h3><div class=nebula-share-buttons><div class="st-custom-button st-remove-label" data-network=wechat><img alt="wechat-white sharing button" src=https://platform-cdn.sharethis.com/img/wechat-white.svg></div><div class="st-custom-button st-remove-label" data-network=weibo><img alt="weibo-white sharing button" src=https://platform-cdn.sharethis.com/img/weibo-white.svg></div><div class="st-custom-button st-remove-label" data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg></div><div class="st-custom-button st-remove-label" data-network=sharethis><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg></div></div></div></div><section class=blog-content><h1>分布式图数据库 Nebula Graph 的 Index 实践</h1><div class=blog-metas><div class=meta><img src=/images/writer.png width=16px height=16px>
<span>sky</span></div><div class=meta><img src=/images/calendar.png width=16px height=16px>
<span>2020-03-12</span></div><div class="tags meta"><img src=/images/tag.png width=16px height=16px>
<a href=/nebula-website/cn//tags/%E7%89%B9%E6%80%A7%E8%AE%B2%E8%A7%A3>特性讲解</a></div></div><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index01.png alt></p><h2 id=导读>导读</h2><p>索引是数据库系统中不可或缺的一个功能，数据库索引好比是书的目录，能加快数据库的查询速度，其实质是数据库管理系统中一个排序的数据结构。不同的数据库系统有不同的排序结构，目前常见的索引实现类型如 B-Tree index、B+-Tree index、B*-Tree index、Hash index、Bitmap index、Inverted index 等等，各种索引类型都有各自的排序算法。</p><p>虽然索引可以带来更高的查询性能，但是也存在一些缺点，例如：</p><ul><li>创建索引和维护索引要耗费额外的时间,往往是随着数据量的增加而维护成本增大</li><li>索引需要占用物理空间</li><li>在对数据进行增删改的操作时需要耗费更多的时间,因为索引也要进行同步的维护</li></ul><p>Nebula Graph 作为一个高性能的分布式图数据库，对于属性值的高性能查询，同样也实现了索引功能。本文将对 Nebula Graph 的索引功能做一个详细介绍。</p><h2 id=图数据库-nebula-graph-术语>图数据库 Nebula Graph 术语</h2><p>开始之前，这里罗列一些可能会使用到的图数据库和 Nebula Graph 专有术语：</p><ul><li>Tag：点的属性结构，一个 Vertex 可以附加多种 tag，以 TagID 标识。（如果类比 SQL，可以理解为一张点表）</li><li>Edge：类似于 Tag，EdgeType 是边上的属性结构，以 EdgeType 标识。（如果类比 SQL，可以理解为一张边表）</li><li>Property：tag / edge 上的属性值，其数据类型由 tag / edge 的结构确定。</li><li>Partition：Nebula Graph 的最小逻辑存储单元，一个 StorageEngine 可包含多个 Partition。Partition 分为 leader 和 follower 的角色，Raftex 保证了 leader 和 follower 之间的数据一致性。</li><li>Graph space：每个 Graph Space 是一个独立的业务 Graph 单元，每个 Graph Space 有其独立的 tag 和 edge 集合。一个 Nebula Graph 集群中可包含多个 Graph Space。</li><li>Index：本文中出现的 Index 指 nebula graph 中点和边上的属性索引。其数据类型依赖于 tag / edge。</li><li>TagIndex：基于 tag 创建的索引，一个 tag 可以创建多个索引。目前（2020.3）暂不支持跨 tag 的复合索引，因此一个索引只可以基于一个 tag。</li><li>EdgeIndex：基于 Edge 创建的索引。同样，一个 Edge 可以创建多个索引，但一个索引只可以基于一个 edge。</li><li>Scan Policy：Index 的扫描策略，往往一条查询语句可以有多种索引的扫描方式，但具体使用哪种扫描方式需要 Scan Policy 来决定。</li><li>Optimizer：对查询条件进行优化，例如对 where 子句的表达式树进行子表达式节点的排序、分裂、合并等。其目的是获取更高的查询效率。</li></ul><h2 id=索引需求分析>索引需求分析</h2><p>Nebula Graph 是一个图数据库系统，查询场景一般是由一个点出发，找出指定边类型的相关点的集合，以此类推进行（广度优先遍历）N 度查询。另一种查询场景是给定一个属性值，找出符合这个属性值的所有的点或边。在后面这种场景中，需要对属性值进行高性能的扫描，查出与此属性值对应的边或点，以及边或点上的其它属性。为了提高属性值的查询效率，在这里引入了索引的功能。对边或点的属性值进行排序，以便快速的定位到某个属性上。以此避免了全表扫描。</p><p>可以看到对图数据库 Nebula Graph 的索引要求：</p><ul><li>支持 tag 和 edge 的属性索引</li><li>支持索引的扫描策略的分析和生成</li><li>支持索引的管理，如：新建索引、重建索引、删除索引、list | show 索引等。</li></ul><h2 id=系统架构概览>系统架构概览</h2><h3 id=图数据库-nebula-graph-存储架构>图数据库 Nebula Graph 存储架构</h3><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index02.png alt></p><p>从架构图可以看到，每个Storage Server 中可以包含多个 Storage Engine, 每个 Storage Engine中可以包含多个Partition, 不同的Partition之间通过 Raft 协议进行一致性同步。每个 Partition 中既包含了 data，也包含了 index，同一个点或边的 data 和 index 将被存储到同一个 Partition 中。</p><h2 id=业务具体分析>业务具体分析</h2><h3 id=数据存储结构>数据存储结构</h3><p>为了更好的描述索引的存储结构，这里将图数据库 Nebula Graph 原始数据的存储结构一起拿出来分析下。</p><h4 id=点的存储结构>点的存储结构</h4><h5 id=点的-data-结构>点的 Data 结构</h5><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index03.png alt></p><h5 id=点的-index-结构>点的 Index 结构</h5><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index04.png alt></p><p>Vertex 的索引结构如上表所示，下面来详细地讲述下字段：</p><p><strong>PartitionId</strong>：一个点的数据和索引在逻辑上是存放到同一个分区中的。之所以这么做的原因主要有两点：</p><ol><li>当扫描索引时，根据索引的 key 能快速地获取到同一个分区中的点 data，这样就可以方便地获取这个点的任何一种属性值，即使这个属性列不属于本索引。</li><li>目前 edge 的存储是由起点的 ID Hash 分布，换句话说，一个点的出边存储在哪是由该点的 VertexId 决定的，这个点和它的出边如果被存储到同一个 partition 中，点的索引扫描能快速地定位该点的出边。</li></ol><p><strong>IndexId</strong>：index 的识别码，通过 indexId 可获取指定 index 的元数据信息，例如：index 所关联的 TagId，index 所在列的信息。</p><p><strong>Index binary</strong>：index 的核心存储结构，是所有 index 相关列属性值的字节编码，详细结构将在本文的 #Index binary# 章节中讲解。</p><p><strong>VertexId</strong>：点的识别码，在实际的 data 中，一个点可能会有不同 version 的多行数据。但是在 index 中，<strong>index 没有 Version 的概念，index 始终与最新 Version 的 Tag 所对应</strong>。</p><p>上面讲完字段，我们来简单地实践分析一波：</p><p>假设 <em>PartitionId</em> 为 100，TagId 有 tag_1 和 tag_2，_其中 tag_1 包含三列 ：col_t1_1、col_t1_2、col_t1_3，tag_2 包含两列：col_t2_1、col_t2_2。</p><p>现在我们来创建索引：</p><ul><li>i1 = tag_1 (col_t1_1, col_t1_2) ，假设 i1 的 ID 为 1；</li><li>i2 = tag_2(col_t2_1, col_t2_2),  假设 i2 的 ID 为 2；</li></ul><p>可以看到虽然 tag_1 中有 col_t1_3 这列，但是建立索引的时候并没有使用到 col_t1_3，<strong>因为在图数据库 Nebula Graph 中索引可以基于 Tag 的一列或多列进行创建</strong>。</p><h5 id=插入点>插入点</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>// VertexId = hash(&#34;v_t1_1&#34;)，假如为 50 
</span><span style=color:#75715e></span>INSERT VERTEX <span style=color:#a6e22e>tag_1</span>(col_t1_1, col_t1_2, col_t1_3), tag_2(col_t2_1, col_t2_2) \
   VALUES hash(<span style=color:#e6db74>&#34;v_t1_1&#34;</span>)<span style=color:#f92672>:</span>(<span style=color:#e6db74>&#34;v_t1_1&#34;</span>, <span style=color:#e6db74>&#34;v_t1_2&#34;</span>, <span style=color:#e6db74>&#34;v_t1_3&#34;</span>, <span style=color:#e6db74>&#34;v_t2_1&#34;</span>, <span style=color:#e6db74>&#34;v_t2_2&#34;</span>);
</code></pre></div><p>从上可以看到 VertexId 可由 ID 标识对应的数值经过 Hash 得到，如果标识对应的数值本身已经为 int64，则无需进行 Hash 或者其他转化数值为 int64 的运算。而此时数据存储如下：</p><p><strong>此时点的 Data 结构</strong></p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index05.png alt></p><p><strong>此时点的 Index 结构</strong></p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index06.png alt></p><p>说明：index 中 row 和 key 是一个概念，为索引的唯一标识；</p><h4 id=边的存储结构>边的存储结构</h4><p>边的索引结构和点索引结构原理类似，这里不再赘述。但有一点需要说明，为了使索引 key 的唯一性成立，索引的 key 的生成借助了不少 data 中的元素，例如 VertexId、SrcVertexId、Rank 等，这也是为什么点索引中并没有 TagId 字段（边索引中也没有 EdgeType 字段），这是因为 <strong>IndexId 本身带有 VertexId 等信息可直接区分具体的 tagId 或 EdgeType</strong>。</p><h5 id=边的-data-结构>边的 Data 结构</h5><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index07.png alt></p><h5 id=边的-index-结构>边的 Index 结构</h5><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index08.png alt></p><h3 id=index-binary-介绍>Index binary 介绍</h3><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index09.png alt></p><p>Index binary 是 index 的核心字段，在 index binary 中区分定长字段和不定长字段，int、double、bool 为定长字段，string 则为不定长字段。由于 <strong>index binary 是将所有 index column 的属性值编码连接存储</strong>，为了精确地定位不定长字段，Nebula Graph 在 index binary 末尾用 int32 记录了不定长字段的长度。</p><p>举个例子：</p><p>我们现在有一个 index binary 为 index1，是由 int 类型的索引列1 c1、string 类型的索引列 c2，string 类型的索引列 c3 组成：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>index1 <span style=color:#f92672>(</span>c1:int, c2:string, c3:string<span style=color:#f92672>)</span>
</code></pre></div><p>假如索引列 c1、c2、c3 某一行对应的 property 值分别为：23、&ldquo;abc&rdquo;、&ldquo;here&rdquo;，则在 index1 中这些索引列将被存储为如下（在示例中为了便于理解，我们直接用原值，实际存储中是原值会经过编码再存储）：</p><ul><li>length = sizeof(&ldquo;abc&rdquo;) = 3</li><li>length = sizeof(&ldquo;here&rdquo;) = 4</li></ul><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index10.png alt></p><p>所以 index1 该 row 对应的 key 则为 23abchere34；</p><p>回到我们 Index binary 章节开篇说的 index binary 格式中存在 <code>Variable-length field lenght</code> 字段，那么这个字段的的具体作用是什么呢？我们来简单地举个例：</p><p>现在我们又有了一个 index binary，我们给它取名为 index2，它由 string 类型的索引列1 c1、string 类型的索引列 c2，string 类型的索引列 c3 组成：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>index2 <span style=color:#f92672>(</span>c1:string, c2:string, c3:string<span style=color:#f92672>)</span>
</code></pre></div><p>假设我们现在 c1、c2、c3 分别有两组如下的数值：</p><ul><li>row1 : (&ldquo;ab&rdquo;, &ldquo;ab&rdquo;, &ldquo;ab&rdquo;)</li><li>row2: (&ldquo;aba&rdquo;, &ldquo;ba&rdquo;, &ldquo;b&rdquo;)</li></ul><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index11.png alt></p><p>可以看到这两行的 prefix（上图红色部分）是相同，都是 &ldquo;ababab&rdquo;，这时候怎么区分这两个 row 的 index binary 的 key 呢？别担心，我们有 <code>Variable-length field lenght</code> 。</p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Index12.png alt></p><p>若遇到 where c1 == &ldquo;ab&rdquo; 这样的条件查询语句，在 Variable-length field length 中可直接根据顺序读取出 c1 的长度，再根据这个长度取出 row1 和 row2 中 c1 的值，分别是 &ldquo;ab&rdquo; 和 &ldquo;aba&rdquo; ，这样我们就精准地判断出只有 row1 中的 &ldquo;ab&rdquo; 是符合查询条件的。</p><h3 id=索引的处理逻辑>索引的处理逻辑</h3><h4 id=index-write>Index write</h4><p>当 Tag / Edge中的一列或多列创建了索引后，一旦涉及到 Tag / Edge 相关的写操作时，对应的索引必须连同数据一起被修改。下面将对索引的write操作在storage层的处理逻辑进行简单介绍：</p><h5 id=insert插入数据>INSERT——插入数据</h5><p>当用户产生插入点/边操作时，insertProcessor 首先会判断所插入的数据是否有存在索引的 Tag 属性 / Edge 属性。如果没有关联的属性列索引，则按常规方式生成新 Version，并将数据 put 到 Storage Engine；如果有关联的属性列索引，则通过原子操作写入 Data 和 Index，并判断当前的 Vertex / Edge 是否有旧的属性值，如果有，则一并在原子操作中删除旧属性值。</p><h5 id=delete删除数据>DELETE——删除数据</h5><p>当用户发生 Drop Vertex / Edge 操作时，deleteProcessor 会将 Data 和 Index（如果存在）一并删除，在删除的过程中同样需要使用原子操作。</p><h5 id=update更新数据>UPDATE——更新数据</h5><p>Vertex / Edge 的更新操作对于 Index 来说，则是 drop 和 insert 的操作：删除旧的索引，插入新的索引，为了保证数据的一致性，同样需要在原子操作中进行。但是对应普通的 Data 来说，仅仅是 insert 操作，使用最新 Version 的 Data 覆盖旧 Version 的 data 即可。</p><h4 id=index-scan>Index scan</h4><p>在图数据库 Nebula Graph 中是用 <code>LOOKUP</code> 语句来处理 index scan 操作的，<code>LOOKUP</code> 语句可通过属性值作为判断条件，查出所有符合条件的点/边，同样 <code>LOOKUP</code> 语句支持 <code>WHERE</code> 和 <code>YIELD</code> 子句。 </p><h6 id=lookup-使用技巧>LOOKUP 使用技巧</h6><p>正如根据本文#数据存储结构#章节所描述那样，index 中的索引列是按照创建 index 时的列顺序决定。</p><p>举个例子，我们现在有 tag (col1, col2)，根据这个 tag 我们可以创建不同的索引，例如：</p><ul><li>index1 on tag(col1)</li><li>index2 on tag(col2)</li><li>index3 on tag(col1, col2)</li><li>index4 on tag(col2, col1)</li></ul><p>我们可以对 clo1、col2 建立多个索引，但在 scan index 时，上述四个 index 返回结果存在差异，甚至是完全不同，在实际业务中具体使用哪个 index，及 index 的最优执行策略，则是通过索引优化器决定。</p><p>下面我们再来根据刚才 4 个 index 的例子深入分析一波：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>lookup on tag where tag.col1 <span style=color:#f92672>==</span><span style=color:#ae81ff>1</span>  <span style=color:#75715e># 最优的 index 是 index1</span>
lookup on tag where tag.col2 <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#75715e># 最优的 index 是index2</span>
lookup on tag where tag.col1 &gt; <span style=color:#ae81ff>1</span> and tag.col2 <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> 
<span style=color:#75715e># index3 和 index4 都是有效的 index，而 index1 和 index2 则无效</span>
</code></pre></div><p>在上述第三个例子中，index3 和 index4 都是有效 index，但最终必须要从两者中选出来一个作为 index，根据优化规则，因为 tag.col2 == 1 是一个<strong>等价查询</strong>，因此<strong>优先使用</strong> tag.col2 会更高效，所以优化器应该选出 index4 为最优 index。</p><h2 id=实操一下图数据库-nebula-graph-索引>实操一下图数据库 Nebula Graph 索引</h2><p>在这部分我们就不具体讲解某个语句的用途是什么了，如果你对语句不清楚的话可以去图数据库 Nebula Graph 的官方论坛进行提问：<a href=https://discuss.nebula-graph.com.cn/>https://discuss.nebula-graph.com.cn/</a></p><h3 id=create索引的创建>CREATE——索引的创建</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [(none)]<span style=color:#f92672>&gt;</span> CREATE SPACE my_space(partition_num<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, replica_factor<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
Execution <span style=color:#a6e22e>succeeded</span> (Time spent: <span style=color:#ae81ff>15.566</span><span style=color:#f92672>/</span><span style=color:#ae81ff>16.602</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>46</span><span style=color:#f92672>:</span><span style=color:#ae81ff>38</span> <span style=color:#ae81ff>2020</span>

(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [(none)]<span style=color:#f92672>&gt;</span> USE my_space;
Execution <span style=color:#a6e22e>succeeded</span> (Time spent: <span style=color:#ae81ff>7.681</span><span style=color:#f92672>/</span><span style=color:#ae81ff>8.303</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>46</span><span style=color:#f92672>:</span><span style=color:#ae81ff>51</span> <span style=color:#ae81ff>2020</span>

(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> CREATE TAG lookup_tag_1(col1 string, col2 string, col3 string);
Execution <span style=color:#a6e22e>succeeded</span> (Time spent: <span style=color:#ae81ff>12.228</span><span style=color:#f92672>/</span><span style=color:#ae81ff>12.931</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>47</span><span style=color:#f92672>:</span><span style=color:#ae81ff>05</span> <span style=color:#ae81ff>2020</span>

(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> CREATE TAG INDEX t_index_1 ON lookup_tag_1(col1, col2, col3);
Execution succeeded (Time spent: <span style=color:#ae81ff>1.639</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2.271</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>47</span><span style=color:#f92672>:</span><span style=color:#ae81ff>22</span> <span style=color:#ae81ff>2020</span>
</code></pre></div><h3 id=drop删除索引>DROP——删除索引</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> DROP TAG INDEX t_index_1;
Execution succeeded (Time spent: <span style=color:#ae81ff>4.147</span><span style=color:#f92672>/</span><span style=color:#ae81ff>5.192</span> ms)

Sat Feb <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>30</span><span style=color:#f92672>:</span><span style=color:#ae81ff>35</span> <span style=color:#ae81ff>2020</span>
</code></pre></div><h3 id=rebuild重建索引>REBUILD——重建索引</h3><p>如果你是从较老版本的 Nebula Graph 升级上来，或者用 Spark Writer 批量写入过程中（为了性能）没有打开索引，那么这些数据还没有建立过索引，这时可以使用 REBUILD INDEX 命令来重新全量建立一次索引。这个过程可能会耗时比较久，在 rebuild index 完成前，客户端的读写速度都会变慢。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>REBUILD {TAG <span style=color:#f92672>|</span> EDGE} INDEX <span style=color:#f92672>&lt;</span>index_name<span style=color:#f92672>&gt;</span> [OFFLINE]
</code></pre></div><h3 id=lookup使用索引>LOOKUP——使用索引</h3><p>需要说明一下，使用 LOOKUP 语句前，请确保已经建立过索引（CREATE INDEX 或 REBUILD INDEX）。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> INSERT VERTEX lookup_tag_1(col1, col2, col3) VALUES <span style=color:#ae81ff>200</span><span style=color:#f92672>:</span>(<span style=color:#e6db74>&#34;col1_200&#34;</span>, <span style=color:#e6db74>&#34;col2_200&#34;</span>, <span style=color:#e6db74>&#34;col3_200&#34;</span>),  <span style=color:#ae81ff>201</span><span style=color:#f92672>:</span>(<span style=color:#e6db74>&#34;col1_201&#34;</span>, <span style=color:#e6db74>&#34;col2_201&#34;</span>, <span style=color:#e6db74>&#34;col3_201&#34;</span>), <span style=color:#ae81ff>202</span><span style=color:#f92672>:</span>(<span style=color:#e6db74>&#34;col1_202&#34;</span>, <span style=color:#e6db74>&#34;col2_202&#34;</span>, <span style=color:#e6db74>&#34;col3_202&#34;</span>);
Execution <span style=color:#a6e22e>succeeded</span> (Time spent: <span style=color:#ae81ff>18.185</span><span style=color:#f92672>/</span><span style=color:#ae81ff>19.267</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>49</span><span style=color:#f92672>:</span><span style=color:#ae81ff>44</span> <span style=color:#ae81ff>2020</span>

(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> LOOKUP ON lookup_tag_1 WHERE lookup_tag_1.col1 <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;col1_200&#34;</span>;
<span style=color:#f92672>============</span>
<span style=color:#f92672>|</span> VertexID <span style=color:#f92672>|</span>
<span style=color:#f92672>============</span>
<span style=color:#f92672>|</span> <span style=color:#ae81ff>200</span>      <span style=color:#f92672>|</span>
<span style=color:#f92672>------------</span>
Got <span style=color:#ae81ff>1</span> rows (Time spent: <span style=color:#ae81ff>12.001</span><span style=color:#f92672>/</span><span style=color:#ae81ff>12.64</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>49</span><span style=color:#f92672>:</span><span style=color:#ae81ff>54</span> <span style=color:#ae81ff>2020</span>

(user<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>6999</span>) [my_space]<span style=color:#f92672>&gt;</span> LOOKUP ON lookup_tag_1 WHERE lookup_tag_1.col1 <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;col1_200&#34;</span> YIELD lookup_tag_1.col1, lookup_tag_1.col2, lookup_tag_1.col3;
<span style=color:#f92672>========================================================================</span>
<span style=color:#f92672>|</span> VertexID <span style=color:#f92672>|</span> lookup_tag_1.col1 <span style=color:#f92672>|</span> lookup_tag_1.col2 <span style=color:#f92672>|</span> lookup_tag_1.col3 <span style=color:#f92672>|</span>
<span style=color:#f92672>========================================================================</span>
<span style=color:#f92672>|</span> <span style=color:#ae81ff>200</span>      <span style=color:#f92672>|</span> col1_200          <span style=color:#f92672>|</span> col2_200          <span style=color:#f92672>|</span> col3_200          <span style=color:#f92672>|</span>
<span style=color:#f92672>------------------------------------------------------------------------</span>
Got <span style=color:#ae81ff>1</span> rows (Time spent: <span style=color:#ae81ff>3.679</span><span style=color:#f92672>/</span><span style=color:#ae81ff>4.657</span> ms)

Thu Feb <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>50</span><span style=color:#f92672>:</span><span style=color:#ae81ff>36</span> <span style=color:#ae81ff>2020</span>
</code></pre></div><p>索引的介绍就到此为止了，如果你对图数据库 Nebula Graph 的索引有更多的功能要求或者建议反馈，欢迎去 GitHub：<a href=https://github.com/vesoft-inc/nebula>https://github.com/vesoft-inc/nebula</a> issue 区向我们提 issue 或者前往官方论坛：<a href=https://discuss.nebula-graph.com.cn/>https://discuss.nebula-graph.com.cn/</a> 的 <code>建议反馈</code>  分类下提建议 👏</p><h2 id=推荐阅读>推荐阅读</h2><ul><li><a href=https://nebula-graph.io/cn/posts/introduction-to-snapshot-in-nebula-graph/>分布式图数据库 Nebula Graph 中的集群快照实践</a></li><li><a href=https://nebula-graph.io/cn/posts/clean-stale-data-with-ttl-in-nebula-graph/>图数据库 Nebula Graph TTL 特性</a></li></ul><blockquote><p>作者有话说：Hi，我是 bright-starry-sky，是图数据 Nebula Graph 研发工程师，对数据库存储有浓厚的兴趣，希望本次的经验分享能给大家带来帮助，如有不当之处也希望能帮忙纠正，谢谢~</p></blockquote><blockquote class=star-ads><span>你喜欢这篇文章吗? 喜欢的话，给我们点个</span>
<span>star 吧:</span>
<a href=https://github.com/vesoft-inc/nebula onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via blogbody'});">https://github.com/vesoft-inc/nebula</a></blockquote><ul class=blog-footer><li><img src=/images/tag.png>
<a href=/nebula-website/cn/tags/%E7%89%B9%E6%80%A7%E8%AE%B2%E8%A7%A3>特性讲解</a></li><li class="nebula-share st-btn"><img src=/images/share.png>
<span>分享</span><ul class=blog-footer-share-links><li class=st-custom-button data-network=wechat><img alt="wechat-white sharing button" src=https://platform-cdn.sharethis.com/img/wechat-white.svg>
<span class=st-label>微信</span></li><li class=st-custom-button data-network=weibo><img alt="weibo-white sharing button" src=https://platform-cdn.sharethis.com/img/weibo-white.svg>
<span class=st-label>微博</span></li><li class=st-custom-button data-network=sharethis><img alt="sharethis-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg>
<span class=st-label>其他</span></li></ul></li><li onclick="location.href='\/nebula-website\/cn\/posts'"><img src=/images/blog.png>
<a href=/nebula-website/cn/posts>返回到博客页</a></li><li onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'RSS via blogbody'});window.open('https:\/\/nebula-graph.io/cn/posts/index.xml');"><img src=/images/rss.png>
<a href=javascript:void(0);>RSS</a></li></ul><div id=discourse-comments></div></section><div class=single-side-bar><div class=tags-block><h3><img src=/img/LabelTagIcon.png>标签</h3><ul class=blog-tags><li class=col-md-12><a href=/nebula-website/cn/posts class=active>全部</a></li><li><a href=/nebula-website/cn/tags/release-note>Release-Note</a></li><li><a href=/nebula-website/cn/tags/%E4%BA%A7%E5%93%81%E5%8A%A8%E6%80%81>产品动态</a></li><li><a href=/nebula-website/cn/tags/%E4%BA%A7%E5%93%81%E8%AE%B2%E8%A7%A3>产品讲解</a></li><li><a href=/nebula-website/cn/tags/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9F%A5%E8%AF%86>图数据库知识</a></li><li><a href=/nebula-website/cn/tags/%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5>应用实践</a></li><li><a href=/nebula-website/cn/tags/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97>开发日志</a></li><li><a href=/nebula-website/cn/tags/%E6%80%A7%E8%83%BD>性能</a></li><li><a href=/nebula-website/cn/tags/%E6%8A%80%E6%9C%AF%E6%BC%94%E8%AE%B2>技术演讲</a></li><li><a href=/nebula-website/cn/tags/%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90>架构剖析</a></li><li><a href=/nebula-website/cn/tags/%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80>查询语言</a></li><li><a href=/nebula-website/cn/tags/%E7%89%B9%E6%80%A7%E8%AE%B2%E8%A7%A3 class=active>特性讲解</a></li><li><a href=/nebula-website/cn/tags/%E7%A4%BE%E5%8C%BA>社区</a></li><li><a href=/nebula-website/cn/tags/%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95>系统测试</a></li><li><a href=/nebula-website/cn/tags/%E7%BC%96%E8%AF%91>编译</a></li><li><a href=/nebula-website/cn/tags/%E9%83%A8%E7%BD%B2>部署</a></li></ul></div><div class=blog-anchors id=J_Anchor><h3>目录</h3><nav id=TableOfContents><ul><li><a href=#导读>导读</a></li><li><a href=#图数据库-nebula-graph-术语>图数据库 Nebula Graph 术语</a></li><li><a href=#索引需求分析>索引需求分析</a></li><li><a href=#系统架构概览>系统架构概览</a><ul><li><a href=#图数据库-nebula-graph-存储架构>图数据库 Nebula Graph 存储架构</a></li></ul></li><li><a href=#业务具体分析>业务具体分析</a><ul><li><a href=#数据存储结构>数据存储结构</a></li><li><a href=#index-binary-介绍>Index binary 介绍</a></li><li><a href=#索引的处理逻辑>索引的处理逻辑</a></li></ul></li><li><a href=#实操一下图数据库-nebula-graph-索引>实操一下图数据库 Nebula Graph 索引</a><ul><li><a href=#create索引的创建>CREATE——索引的创建</a></li><li><a href=#drop删除索引>DROP——删除索引</a></li><li><a href=#rebuild重建索引>REBUILD——重建索引</a></li><li><a href=#lookup使用索引>LOOKUP——使用索引</a></li></ul></li><li><a href=#推荐阅读>推荐阅读</a></li></ul></nav></div></div></div><img onclick="location.href='#top'" class=go-ahead src=/images/up.png></div><footer class="container-fluid foot-wrap" name=contact_us><div class=container><div class=row><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Community</h3><ul><li><img src=/img/github.png>
<a href=https://github.com/vesoft-inc/nebula target=_blank>GitHub</a></li><li><img src=/img/forum.png>
<a href=https://discuss.nebula-graph.com.cn/ target=_blank>论坛</a></li><li><img src=/img/slack.png>
<a href=https://join.slack.com/t/nebulagraph/shared_invite/enQtNjIzMjQ5MzE2OTQ2LTM0MjY0MWFlODg3ZTNjMjg3YWU5ZGY2NDM5MDhmOGU2OWI5ZWZjZDUwNTExMGIxZTk2ZmQxY2Q2MzM1OWJhMmY# target=_blank>Slack</a></li></ul></div><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Follow Us</h3><ul><li><img src=/img/twitter.png>
<a href=https://twitter.com/NebulaGraph title=Twitter data-toggle=modal target=_blank data-target>Twitter</a></li><li><img src=/img/linkedin.png>
<a href=https://www.linkedin.com/company/vesoft-nebula-graph/ title=LinkedIn data-toggle=modal target=_blank data-target>LinkedIn</a></li><li><img src=/img/youtube.png>
<a href=https://www.youtube.com/channel/UC73V8q795eSEMxDX4Pvdwmw title=YouTube data-toggle=modal target=_blank data-target>YouTube</a></li><li><img src=/img/facebook.png>
<a href=https://www.facebook.com/NebulaGraph/ title=FaceBook data-toggle=modal target=_blank data-target>FaceBook</a></li><li><img src=/img/weibo.png>
<a href=https://weibo.com/nebulagraph title=微博 data-toggle=modal target=_blank data-target>微博</a></li><li><img src=/img/gongzhonghao.png>
<a href title=微信公众号 data-toggle=modal target=_blank data-target=#myGongzhonghaoModal>微信公众号</a></li></ul></div><div class="contactus row-content col-lg-4 col-sm-4 col-xs-4"><h3>Contact Us</h3><ul><li><img src=/img/iphone.png>
<a href data-toggle=modal target=_blank data-target>(+86) 0571-28120658</a></li><li><img src=/img/email.png>
<a href=mailto:info@vesoft.com data-toggle=modal target=_blank data-target>info@vesoft.com</a></li><li><img src=/img/weixin.png>
<a href data-toggle=modal target=_blank data-target=#myModal>微信个人助理</a></li></ul></div></div></div><p align=left style=font-size:16px><img src=/images/VEsoft.png style=margin-right:10px> Copyright &copy;2020 VESoft Inc</p><div class="modal fade" id=myGongzhonghaoModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/gonggonghaoCODE.jpg></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div><div class="modal fade" id=myModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/wechat.png></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div></footer></main><div id=J_Star_Popup class=nebula-star-popup></div><script src=/nebula-website/js/jquery.js></script><script src=/nebula-website/js/bootstrap.min.js></script><script src=/nebula-website/js/jquery.easing.min.js></script><script src=/nebula-website/js/jquery.fittext.js></script><script src=/nebula-website/js/wow.min.js></script><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=5e7c2cc315c7990012ae38bc&product=inline-share-buttons" async></script><script src=/nebula-website/js/creative.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script src=/nebula-website/js/init.js></script><script type=text/javascript>DiscourseEmbed={discourseUrl:'https://discuss.nebula-graph.com.cn/',discourseEmbedUrl:"\/nebula-website\/cn\/posts\/how-indexing-works-in-nebula-graph\/"};(function(){var d=document.createElement('script');d.type='text/javascript';d.async=true;d.src=DiscourseEmbed.discourseUrl+'javascripts/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(d);})();</script><script src=/nebula-website/js/anchor.js></script></body></html><script>if(!sessionStorage.getItem("popupIsRemove")){$("#top").css("padding-top","98px")}</script>