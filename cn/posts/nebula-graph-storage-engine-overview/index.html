<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Nebula Graph"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@NebulaGraph"><meta name=twitter:creator content="@NebulaGraph"><meta name=twitter:domain content="nebula-graph.io"><meta name=twitter:title content="Nebula 架构剖析系列（一）图数据库的存储设计"><meta property="twitter:title" content="Nebula 架构剖析系列（一）图数据库的存储设计"><meta name=twitter:description content="在讨论某个数据库时，存储和计算通常是讨论的热点，也是爱好者们了解某个数据库不可或缺的部分，本文主要讲述了存储部分的设计。"><meta name=og:description content="在讨论某个数据库时，存储和计算通常是讨论的热点，也是爱好者们了解某个数据库不可或缺的部分，本文主要讲述了存储部分的设计。"><meta name=twitter:image content="/nebula-website/cn/posts/nebula-graph-storage-engine-overview/Nebula%20Graph%20Storage%20Engine_hu10791d3c5fb174126a65394116bc4ca0_1228479_600x0_resize_box_2.png"><meta name=og:image content="/nebula-website/cn/posts/nebula-graph-storage-engine-overview/Nebula%20Graph%20Storage%20Engine_hu10791d3c5fb174126a65394116bc4ca0_1228479_600x0_resize_box_2.png"><meta name=description content="在讨论某个数据库时，存储和计算通常是讨论的热点，也是爱好者们了解某个数据库不可或缺的部分，本文主要讲述了存储部分的设计。"><meta name=generator content="Hugo 0.65.3"><title>Nebula 架构剖析系列（一）图数据库的存储设计</title><link rel="shortcut icon" href=/nebula-website/favicon.ico><link rel=stylesheet href=/nebula-website/css/bootstrap.min.css type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic" rel=stylesheet type=text/css><link rel=stylesheet href=/nebula-website/font-awesome/css/font-awesome.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/creative.css type=text/css><link rel=stylesheet href=/nebula-website/css/modals.css type=text/css><link rel=stylesheet href=/nebula-website/css/animate.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/custom/index.css type=text/css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/nebula-website/js/jquery.js></script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPJVFGH');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-60523578-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-60523578-5');</script></head><body id=page-top><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPJVFGH" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><nav id=mainNav class="navbar navbar-default navbar-fixed-top"><div class=nav-popup id=nav-popup><img src=/images/popup.png><img src=/images/popup.png> Nebula Graph RC4 已发布！ <a href=https://github.com/vesoft-inc/nebula/releases/tag/v1.0.0-rc4 onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Banner Ad - RC4'})" target=_blank>快来尝鲜</a> <img src=/images/shut.png id=shut onclick=shut()></div><div class=container-fluid><div class=navbar-header><div class=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-icon=octicon-star data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></div><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class="navbar-brand page-scroll" href=/nebula-website/cn/></a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav" id=nav><li class=github-star id=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-size=large data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></li><li><a href=https://docs.nebula-graph.com.cn/ target=_blank>文档</a></li><li class=active><a href=/cn/posts target>博客</a></li><li><a href=https://discuss.nebula-graph.com.cn/ target=_blank>论坛</a></li><li><a href=#contact_us target onclick=contactUsClick()>联系我们</a></li><li class="dropdown navbar-right"><a class=dropdown-toggle data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false><img src=/images/language120x120.png>
<span class=caret></span></a><ul class=dropdown-menu><li class=nav-item><a class=dropdown-item href=/en target>English</a></li><li class=nav-item><a class=dropdown-item href=/cn target>中文</a></li></ul></li><li id=navbar-right><a href=https://github.com/vesoft-inc/nebula-web-docker target=_blank onclick="gtag('event','Button Click',{event_category:'Engagement',event_label:'Nebula Studio'})">Nebula Studio</a></li></ul></div></div></nav><script>function contactUsClick(){$('html,body').animate({scrollTop:document.documentElement.scrollHeight},800)
return false;}
function shut(){$('#nav-popup').remove();$("#top").css("padding-top","50px")
sessionStorage.setItem("popupIsRemove",true);}
if(!sessionStorage.getItem("popupIsRemove")){$("#nav-popup").css("display","block")}</script><main id=top class=blog-detail><div class=wrapper><div class=inner><div class=blog-left-aside><div class=social-share id=J_Share><h3>分享</h3><div class=nebula-share-buttons><div class="st-custom-button st-remove-label" data-network=wechat><img alt="wechat-white sharing button" src=https://platform-cdn.sharethis.com/img/wechat-white.svg></div><div class="st-custom-button st-remove-label" data-network=weibo><img alt="weibo-white sharing button" src=https://platform-cdn.sharethis.com/img/weibo-white.svg></div><div class="st-custom-button st-remove-label" data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg></div><div class="st-custom-button st-remove-label" data-network=sharethis><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg></div></div></div></div><section class=blog-content><h1>Nebula 架构剖析系列（一）图数据库的存储设计</h1><div class=blog-metas><div class=meta><img src=/images/writer.png width=16px height=16px>
<span>陈恒</span></div><div class=meta><img src=/images/calendar.png width=16px height=16px>
<span>2019-10-15</span></div><div class="tags meta"><img src=/images/tag.png width=16px height=16px>
<a href=/nebula-website/cn//tags/%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90>架构剖析</a></div></div><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0101.png alt=image></p><h2 id=摘要>摘要</h2><p>在讨论某个数据库时，存储 ( Storage ) 和计算 ( Query Engine ) 通常是讨论的热点，也是爱好者们了解某个数据库不可或缺的部分。每个数据库都有其独有的存储、计算方式，今天就和图图来学习下图数据库 Nebula Graph 的存储部分。</p><p>Nebula 的 Storage 包含两个部分， 一是 meta 相关的存储， 我们称之为 <code>Meta Service</code> ，另一个是 data 相关的存储， 我们称之为 <code>Storage Service</code>。 这两个服务是两个独立的进程，数据也完全隔离，当然部署也是分别部署， 不过两者整体架构相差不大，本文最后会提到这点。 如果没有特殊说明，本文中 Storage Service 代指 data 的存储服务。接下来，大家就随我一起看一下 Storage Service 的整个架构。 Let&rsquo;s go~</p><h2 id=architecture>Architecture</h2><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0102.png alt="storage service"></p><p>图一  storage service 架构图</p><p>如图1 所示，Storage Service 共有三层，最底层是 Store Engine，它是一个单机版 local store engine，提供了对本地数据的 <code>get</code> / <code>put</code> / <code>scan</code> / <code>delete</code> 操作，相关的接口放在 KVStore / KVEngine.h 文件里面，用户完全可以根据自己的需求定制开发相关 local store plugin，目前 Nebula 提供了基于 RocksDB 实现的  Store Engine。</p><p>在 local store engine 之上，便是我们的 Consensus 层，实现了 Multi Group Raft，每一个 Partition 都对应了一组 Raft Group，这里的 Partition 便是我们的数据分片。目前 Nebula 的分片策略采用了 <code>静态 Hash</code> 的方式，具体按照什么方式进行 Hash，在下一个章节 schema 里会提及。用户在创建 SPACE 时需指定 Partition 数，Partition 数量一旦设置便不可更改，一般来讲，Partition 数目要能满足业务将来的扩容需求。</p><p>在 Consensus 层上面也就是 Storage Service 的最上层，便是我们的 Storage interfaces，这一层定义了一系列和图相关的 API。 这些 API 请求会在这一层被翻译成一组针对相应 Partition 的 kv 操作。正是这一层的存在，使得我们的存储服务变成了真正的图存储，否则，Storage Service 只是一个 kv 存储罢了。而 Nebula 没把 kv 作为一个服务单独提出，其最主要的原因便是图查询过程中会涉及到大量计算，这些计算往往需要使用图的 schema，而 kv 层是没有数据 schema 概念，这样设计会比较容易实现计算下推。</p><h2 id=schema--partition>Schema & Partition</h2><p>图存储的主要数据是点和边，但 Nebula 存储的数据是一张属性图，也就是说除了点和边以外，Nebula 还存储了它们对应的属性，以便更高效地使用属性过滤。</p><p>对于点来说，我们使用不同的 Tag 表示不同类型的点，同一个 VertexID 可以关联多个 Tag，而每一个 Tag 都有自己对应的属性。对应到 kv 存储里面，我们使用 vertexID + TagID 来表示 key,  我们把相关的属性编码后放在 value 里面，具体 key 的 format 如图2 所示：</p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0103.png alt="Vertex Key Format">
图二 Vertex Key Format</p><ul><li><code>Type</code> :  1 个字节，用来表示 key 类型，当前的类型有 data, index, system 等</li><li><code>Part ID</code> : 3 个字节，用来表示数据分片 Partition，此字段主要用于 <strong>Partition 重新分布(balance) 时方便根据前缀扫描整个 Partition 数据</strong></li><li><code>Vertex ID</code> : 4 个字节， 用来表示点的 ID</li><li><code>Tag ID</code> : 4 个字节, 用来表示关联的某个 tag</li><li><code>Timestamp</code> : 8 个字节，对用户不可见，未来实现分布式事务 ( MVCC ) 时使用</li></ul><p>在一个图中，每一条逻辑意义上的边，在 Nebula Graph 中会建模成两个独立的 key-value，分别称为 out-key 和in-key。out-key 与这条边所对应的起点存储在同一个 partition 上，in-key 与这条边所对应的终点存储在同一个partition 上。通常来说，out-key 和 in-key 会分布在两个不同的 Partition 中。</p><p>两个点之间可能存在多种类型的边，Nebula 用 Edge Type 来表示边类型。而同一类型的边可能存在多条，比如，定义一个 edge type &ldquo;转账&rdquo;，用户 A 可能多次转账给 B， 所以 Nebula 又增加了一个 Rank 字段来做区分，表示 A 到 B 之间多次转账记录。 Edge key 的 format 如图3 所示：</p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0104.png alt=image>
图三 Edge Key Format</p><ul><li><code>Type</code> :  1 个字节，用来表示 key 的类型，当前的类型有 data, index, system 等。</li><li><code>Part ID</code> : 3 个字节，用来表示数据分片 Partition，此字段主要用于 <strong>Partition 重新分布(balance) 时方便根据前缀扫描整个 Partition 数据</strong></li><li><code>Vertex ID</code> : 4 个字节， 出边里面用来表示源点的 ID， 入边里面表示目标点的 ID。</li><li><code>Edge Type</code> : 4 个字节, 用来表示这条边的类型，如果大于 0 表示出边，小于 0 表示入边。</li><li><code>Rank</code> : 8 个字节，用来处理同一种类型的边存在多条的情况。用户可以根据自己的需求进行设置，这个字段可_存放交易时间_、_交易流水号_、或_某个排序权重_</li><li><code>Vertex ID</code> : 4 个字节,  出边里面用来表示目标点的 ID， 入边里面表示源点的 ID。</li><li><code>Timestamp</code> : 8 个字节，对用户不可见，未来实现分布式做事务的时候使用。</li></ul><p>针对 Edge Type 的值，若如果大于 0 表示出边，则对应的 edge key format 如图4 所示；若 Edge Type 的值小于 0，则对应的 edge key format 如图5 所示</p><p><img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0105.png alt=image>
图4 出边的 Key Format
<img src=https://nebula-blog.azureedge.net/nebula-blog/Architecture0106.png alt=image>
图5 入边的 Key Format</p><p>对于点或边的属性信息，有对应的一组 kv pairs，Nebula 将它们编码后存在对应的 value 里。由于 Nebula 使用强类型 schema，所以在解码之前，需要先去 Meta Service 中取具体的 schema 信息。另外，为了支持在线变更 schema，在编码属性时，会加入对应的 schema 版本信息，具体的编解码细节在这里不作展开，后续会有专门的文章讲解这块内容。</p><p>OK，到这里我们基本上了解了 Nebula 是如何存储数据的，那数据是如何进行分片呢？很简单，对 Vertex ID <code>取模</code> 即可。通过对 Vertex ID 取模，同一个点的所有_出边_，_入边_以及这个点上所有关联的 _Tag 信息_都会被分到同一个 Partition，这种方式大大地提升了查询效率。对于在线图查询来讲，最常见的操作便是从一个点开始向外 BFS（广度优先）拓展，于是拿一个点的出边或者入边是最基本的操作，而这个操作的性能也决定了整个遍历的性能。BFS 中可能会出现按照某些属性进行剪枝的情况，Nebula 通过将属性与点边存在一起，来保证整个操作的高效。当前许多的图数据库通过 Graph 500 或者 Twitter 的数据集试来验证自己的高效性，这并没有代表性，因为这些数据集没有属性，而实际的场景中大部分情况都是属性图，并且实际中的 BFS 也需要进行大量的剪枝操作。</p><h2 id=kvstore>KVStore</h2><p>为什么要自己做 KVStore，这是我们无数次被问起的问题。理由很简单，当前开源的 KVStore 都很难满足我们的要求：</p><ul><li><strong>性能</strong>，<strong>性能</strong>，<strong>性能</strong>：Nebula 的需求很直接：高性能 pure kv；</li><li><strong>以 library 的形式提供</strong>：对于强 schema 的 Nebula 来讲，计算下推需要 schema 信息，而计算下推实现的好坏，是 Nebula 是否高效的关键；</li><li><strong>数据强一致</strong>：这是分布式系统决定的；</li><li><strong>使用 C++实现</strong>：这由团队的技术特点决定；</li></ul><p>基于上述要求，Nebula 实现了自己的 KVStore。当然，对于性能完全不敏感且不太希望搬迁数据的用户来说，Nebula 也提供了整个KVStore 层的 plugin，直接将 Storage Service 搭建在第三方的 KVStore 上面，目前官方提供的是 HBase 的 plugin。</p><p>Nebula KVStore 主要采用 RocksDB 作为本地的存储引擎，对于多硬盘机器，为了充分利用多硬盘的并发能力，Nebula 支持自己管理多块盘，用户只需配置多个不同的数据目录即可。分布式 KVStore 的管理由 Meta Service 来统一调度，它记录了所有 Partition 的分布情况，以及当前机器的状态，当用户增减机器时，只需要通过 console 输入相应的指令，Meta Service 便能够生成整个 balance plan 并执行。（之所以没有采用完全自动 balance 的方式，主要是为了减少数据搬迁对于线上服务的影响，balance 的时机由用户自己控制。）</p><p>为了方便对于 WAL 进行定制，Nebula KVStore 实现了自己的 WAL 模块，每个 partition 都有自己的 WAL，这样在追数据时，不需要进行 wal split 操作， 更加高效。 另外，为了实现一些特殊的操作，专门定义了 Command Log 这个类别，这些 log 只为了使用 Raft 来通知所有 replica 执行某一个特定操作，并没有真正的数据。除了 Command Log 外，Nebula 还提供了一类日志来实现针对某个 Partition 的 atomic operation，例如 CAS，read-modify-write,  它充分利用了Raft 串行的特性。</p><p>关于多图空间（space）的支持：一个 Nebula KVStore 集群可以支持多个 space，每个 space 可设置自己的 partition 数和 replica 数。不同 space 在物理上是完全隔离的，而且在同一个集群上的不同 space 可支持不同的 store engine 及分片策略。</p><h2 id=raft>Raft</h2><p>作为一个分布式系统，KVStore 的 replication，scale out 等功能需 Raft 的支持。当前，市面上讲 Raft 的文章非常多，具体原理性的内容，这里不再赘述，本文主要说一些 Nebula Raft 的一些特点以及工程实现。</p><h3 id=multi-raft-group>Multi Raft Group</h3><p>由于 Raft 的日志不允许空洞，几乎所有的实现都会采用 Multi Raft Group 来缓解这个问题，因此 partition 的数目几乎决定了整个 Raft Group 的性能。但这也并不是说 Partition 的数目越多越好：每一个 Raft Group 内部都要存储一系列的状态信息，并且每一个 Raft Group 有自己的 WAL 文件，因此 Partition 数目太多会增加开销。此外，当 Partition 太多时， 如果负载没有足够高，batch 操作是没有意义的。比如，一个有 1w tps 的线上系统单机，它的单机 partition 的数目超过 1w，可能每个 Partition 每秒的 tps 只有 1，这样 batch 操作就失去了意义，还增加了 CPU 开销。
实现 Multi Raft Group 的最关键之处有两点，<strong>第一是共享 Transport 层</strong>，因为每一个 Raft Group 内部都需要向对应的 peer  发送消息，如果不能共享 Transport 层，连接的开销巨大；<strong>第二是线程模型</strong>，Mutli Raft Group 一定要共享一组线程池，否则会造成系统的线程数目过多，导致大量的 context switch 开销。</p><h3 id=batch>Batch</h3><p>对于每个 Partition来说，由于串行写 WAL，为了提高吞吐，做 batch 是十分必要的。一般来讲，batch 并没有什么特别的地方，但是 Nebula 利用每个 part 串行的特点，做了一些特殊类型的 WAL，带来了一些工程上的挑战。</p><p>举个例子，Nebula 利用 WAL 实现了无锁的 CAS 操作，而每个 CAS 操作需要之前的 WAL 全部 commit 之后才能执行，所以对于一个 batch，如果中间夹杂了几条 CAS 类型的 WAL, 我们还需要把这个 batch 分成粒度更小的几个 group，group 之间保证串行。还有，command 类型的 WAL 需要它后面的 WAL 在其 commit 之后才能执行，所以整个 batch 划分 group 的操作工程实现上比较有特色。</p><h3 id=learner>Learner</h3><p>Learner 这个角色的存在主要是为了 <code>应对扩容</code> 时，新机器需要"追"相当长一段时间的数据，而这段时间有可能会发生意外。如果直接以 follower 的身份开始追数据，就会使得整个集群的 HA 能力下降。 Nebula 里面 learner 的实现就是采用了上面提到的 command wal，leader 在写 wal 时如果碰到 add learner 的 command， 就会将 learner 加入自己的 peers，并把它标记为 learner，这样在统计多数派的时候，就不会算上 learner，但是日志还是会照常发送给它们。当然 learner 也不会主动发起选举。</p><h3 id=transfer-leadership>Transfer Leadership</h3><p>Transfer leadership 这个操作对于 balance 来讲至关重要，当我们把某个 Paritition 从一台机器挪到另一台机器时，首先便会检查 source 是不是 leader，如果是的话，需要先把他挪到另外的 peer 上面；在搬迁数据完毕之后，通常还要把 leader 进行一次 balance，这样每台机器承担的负载也能保证均衡。</p><p>实现 transfer leadership， 需要注意的是 leader 放弃自己的 leadership，和 follower 开始进行 leader election 的时机。对于 leader 来讲，当 transfer leadership command 在 commit 的时候，它放弃 leadership；而对于 follower 来讲，当收到此 command 的时候就要开始进行 leader election， 这套实现要和 Raft 本身的 leader election 走一套路径，否则很容易出现一些难以处理的 corner case。</p><h3 id=membership-change>Membership change</h3><p>为了避免脑裂，当一个 Raft Group 的成员发生变化时，需要有一个中间状态， 这个状态下 old group 的多数派与 new group 的多数派总是有 overlap，这样就防止了 old group 或者新 group 单方面做出决定，这就是<a href=https://raft.github.io/raft.pdf>论文</a>中提到的 <code>joint consensus</code> 。为了更加简化，Diego Ongaro 在自己的博士论文中提出<strong>每次增减一个 peer 的方式</strong>，<strong>以保证 old group 的多数派总是与 new group 的多数派有 overlap</strong>。 Nebula 的实现也采用了这个方式，只不过 add member 与 remove member 的实现有所区别，具体实现方式本文不作讨论，有兴趣的同学可以参考 Raft Part class 里面 <code>addPeer</code>  /  <code>removePeer</code>  的实现。</p><h3 id=snapshot>Snapshot</h3><p>Snapshot 如何与 Raft 流程结合起来，<a href=https://raft.github.io/raft.pdf>论文</a>中并没有细讲，但是这一部分我认为是一个 Raft 实现里最容易出错的地方，因为这里会产生大量的 corner case。</p><p>举一个例子，当 leader 发送 snapshot 过程中，如果 leader 发生了变化，该怎么办？ 这个时候，有可能 follower 只接到了一半的 snapshot 数据。 所以需要有一个 Partition 数据清理过程，由于多个 Partition 共享一份存储，因此如何清理数据又是一个很麻烦的问题。另外，snapshot 过程中，会产生大量的 IO，为了性能考虑，我们不希望这个过程与正常的 Raft 共用一个 IO threadPool，并且整个过程中，还需要使用大量的内存，如何优化内存的使用，对于性能十分关键。由于篇幅原因，我们并不会在本文对这些问题展开讲述，有兴趣的同学可以参考 <code>SnapshotManager</code>  的实现。</p><h2 id=storage-service>Storage Service</h2><p>在 KVStore 的接口之上，Nebula 封装有图语义接口，主要的接口如下：</p><ul><li><code>getNeighbors</code> :  查询一批点的出边或者入边，返回边以及对应的属性，并且需要支持条件过滤；</li><li><code>Insert vertex/edge</code> :  插入一条点或者边及其属性；</li><li><code>getProps</code> : 获取一个点或者一条边的属性；</li></ul><p>这一层会将图语义的接口转化成 kv 操作。为了提高遍历的性能，还要做并发操作。</p><h2 id=meta-service>Meta Service</h2><p>在 KVStore 的接口上，Nebula 也同时封装了一套 meta 相关的接口。Meta Service 不但提供了图 schema 的增删查改的功能，还提供了集群的管理功能以及用户鉴权相关的功能。Meta Service 支持单独部署，也支持使用多副本来保证数据的安全。</p><h2 id=总结>总结</h2><p>这篇文章给大家大致介绍了 Nebula Storage 层的整体设计， 由于篇幅原因， 很多细节没有展开讲， 欢迎大家到我们的微信群里提问，加入 Nebula Graph 交流群，请联系 Nebula Graph 官方小助手微信号：NebulaGraphbot。</p><h2 id=推荐阅读>推荐阅读</h2><ul><li><a href=https://nebula-graph.io/cn/posts/nebula-graph-architecture-overview/>Nebula 架构剖析系列（零）图数据库的整体架构设计</a></li><li><a href=https://nebula-graph.io/cn/posts/nebula-graph-query-engine-overview/>Nebula 架构剖析系列（二）图数据库的查询引擎设计</a></li></ul><blockquote class=star-ads><span>你喜欢这篇文章吗? 喜欢的话，给我们点个</span>
<span>star 吧:</span>
<a href=https://github.com/vesoft-inc/nebula onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via blogbody'});">https://github.com/vesoft-inc/nebula</a></blockquote><ul class=blog-footer><li><img src=/images/tag.png>
<a href=/nebula-website/cn/tags/%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90>架构剖析</a></li><li class="nebula-share st-btn"><img src=/images/share.png>
<span>分享</span><ul class=blog-footer-share-links><li class=st-custom-button data-network=wechat><img alt="wechat-white sharing button" src=https://platform-cdn.sharethis.com/img/wechat-white.svg>
<span class=st-label>微信</span></li><li class=st-custom-button data-network=weibo><img alt="weibo-white sharing button" src=https://platform-cdn.sharethis.com/img/weibo-white.svg>
<span class=st-label>微博</span></li><li class=st-custom-button data-network=sharethis><img alt="sharethis-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg>
<span class=st-label>其他</span></li></ul></li><li onclick="location.href='\/nebula-website\/cn\/posts'"><img src=/images/blog.png>
<a href=/nebula-website/cn/posts>返回到博客页</a></li><li onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'RSS via blogbody'});window.open('https:\/\/nebula-graph.io/cn/posts/index.xml');"><img src=/images/rss.png>
<a href=javascript:void(0);>RSS</a></li></ul><div id=discourse-comments></div></section><div class=single-side-bar><div class=tags-block><h3><img src=/img/LabelTagIcon.png>标签</h3><ul class=blog-tags><li class=col-md-12><a href=/nebula-website/cn/posts class=active>全部</a></li><li><a href=/nebula-website/cn/tags/release-note>Release-Note</a></li><li><a href=/nebula-website/cn/tags/%E4%BA%A7%E5%93%81%E5%8A%A8%E6%80%81>产品动态</a></li><li><a href=/nebula-website/cn/tags/%E4%BA%A7%E5%93%81%E8%AE%B2%E8%A7%A3>产品讲解</a></li><li><a href=/nebula-website/cn/tags/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9F%A5%E8%AF%86>图数据库知识</a></li><li><a href=/nebula-website/cn/tags/%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5>应用实践</a></li><li><a href=/nebula-website/cn/tags/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97>开发日志</a></li><li><a href=/nebula-website/cn/tags/%E6%80%A7%E8%83%BD>性能</a></li><li><a href=/nebula-website/cn/tags/%E6%8A%80%E6%9C%AF%E6%BC%94%E8%AE%B2>技术演讲</a></li><li><a href=/nebula-website/cn/tags/%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90 class=active>架构剖析</a></li><li><a href=/nebula-website/cn/tags/%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80>查询语言</a></li><li><a href=/nebula-website/cn/tags/%E7%89%B9%E6%80%A7%E8%AE%B2%E8%A7%A3>特性讲解</a></li><li><a href=/nebula-website/cn/tags/%E7%A4%BE%E5%8C%BA>社区</a></li><li><a href=/nebula-website/cn/tags/%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95>系统测试</a></li><li><a href=/nebula-website/cn/tags/%E7%BC%96%E8%AF%91>编译</a></li><li><a href=/nebula-website/cn/tags/%E9%83%A8%E7%BD%B2>部署</a></li></ul></div><div class=blog-anchors id=J_Anchor><h3>目录</h3><nav id=TableOfContents><ul><li><a href=#摘要>摘要</a></li><li><a href=#architecture>Architecture</a></li><li><a href=#schema--partition>Schema & Partition</a></li><li><a href=#kvstore>KVStore</a></li><li><a href=#raft>Raft</a><ul><li><a href=#multi-raft-group>Multi Raft Group</a></li><li><a href=#batch>Batch</a></li><li><a href=#learner>Learner</a></li><li><a href=#transfer-leadership>Transfer Leadership</a></li><li><a href=#membership-change>Membership change</a></li><li><a href=#snapshot>Snapshot</a></li></ul></li><li><a href=#storage-service>Storage Service</a></li><li><a href=#meta-service>Meta Service</a></li><li><a href=#总结>总结</a></li><li><a href=#推荐阅读>推荐阅读</a></li></ul></nav></div></div></div><img onclick="location.href='#top'" class=go-ahead src=/images/up.png></div><footer class="container-fluid foot-wrap" name=contact_us><div class=container><div class=row><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Community</h3><ul><li><img src=/img/github.png>
<a href=https://github.com/vesoft-inc/nebula target=_blank>GitHub</a></li><li><img src=/img/forum.png>
<a href=https://discuss.nebula-graph.com.cn/ target=_blank>论坛</a></li><li><img src=/img/slack.png>
<a href=https://join.slack.com/t/nebulagraph/shared_invite/enQtNjIzMjQ5MzE2OTQ2LTM0MjY0MWFlODg3ZTNjMjg3YWU5ZGY2NDM5MDhmOGU2OWI5ZWZjZDUwNTExMGIxZTk2ZmQxY2Q2MzM1OWJhMmY# target=_blank>Slack</a></li></ul></div><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Follow Us</h3><ul><li><img src=/img/twitter.png>
<a href=https://twitter.com/NebulaGraph title=Twitter data-toggle=modal target=_blank data-target>Twitter</a></li><li><img src=/img/linkedin.png>
<a href=https://www.linkedin.com/company/vesoft-nebula-graph/ title=LinkedIn data-toggle=modal target=_blank data-target>LinkedIn</a></li><li><img src=/img/youtube.png>
<a href=https://www.youtube.com/channel/UC73V8q795eSEMxDX4Pvdwmw title=YouTube data-toggle=modal target=_blank data-target>YouTube</a></li><li><img src=/img/facebook.png>
<a href=https://www.facebook.com/NebulaGraph/ title=FaceBook data-toggle=modal target=_blank data-target>FaceBook</a></li><li><img src=/img/weibo.png>
<a href=https://weibo.com/nebulagraph title=微博 data-toggle=modal target=_blank data-target>微博</a></li><li><img src=/img/gongzhonghao.png>
<a href title=微信公众号 data-toggle=modal target=_blank data-target=#myGongzhonghaoModal>微信公众号</a></li></ul></div><div class="contactus row-content col-lg-4 col-sm-4 col-xs-4"><h3>Contact Us</h3><ul><li><img src=/img/iphone.png>
<a href data-toggle=modal target=_blank data-target>(+86) 0571-28120658</a></li><li><img src=/img/email.png>
<a href=mailto:info@vesoft.com data-toggle=modal target=_blank data-target>info@vesoft.com</a></li><li><img src=/img/weixin.png>
<a href data-toggle=modal target=_blank data-target=#myModal>微信个人助理</a></li></ul></div></div></div><p align=left style=font-size:16px><img src=/images/VEsoft.png style=margin-right:10px> Copyright &copy;2020 VESoft Inc</p><div class="modal fade" id=myGongzhonghaoModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/gonggonghaoCODE.jpg></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div><div class="modal fade" id=myModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/wechat.png></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div></footer></main><div id=J_Star_Popup class=nebula-star-popup></div><script src=/nebula-website/js/jquery.js></script><script src=/nebula-website/js/bootstrap.min.js></script><script src=/nebula-website/js/jquery.easing.min.js></script><script src=/nebula-website/js/jquery.fittext.js></script><script src=/nebula-website/js/wow.min.js></script><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=5e7c2cc315c7990012ae38bc&product=inline-share-buttons" async></script><script src=/nebula-website/js/creative.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script src=/nebula-website/js/init.js></script><script type=text/javascript>DiscourseEmbed={discourseUrl:'https://discuss.nebula-graph.com.cn/',discourseEmbedUrl:"\/nebula-website\/cn\/posts\/nebula-graph-storage-engine-overview\/"};(function(){var d=document.createElement('script');d.type='text/javascript';d.async=true;d.src=DiscourseEmbed.discourseUrl+'javascripts/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(d);})();</script><script src=/nebula-website/js/anchor.js></script></body></html><script>if(!sessionStorage.getItem("popupIsRemove")){$("#top").css("padding-top","98px")}</script>