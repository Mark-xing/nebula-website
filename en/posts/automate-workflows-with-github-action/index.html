<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Nebula Graph"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@NebulaGraph"><meta name=twitter:creator content="@NebulaGraph"><meta name=twitter:domain content="nebula-graph.io"><meta name=twitter:title content="Automate Workflows with Github Action in Nebula Graph"><meta property="twitter:title" content="Automate Workflows with Github Action in Nebula Graph"><meta name=twitter:description content="Nebula Graph has adopted GitHub Actions to automate testing and releasing workflows like Nightly building and branch release. This post shared some best practices with you in this regard."><meta name=og:description content="Nebula Graph has adopted GitHub Actions to automate testing and releasing workflows like Nightly building and branch release. This post shared some best practices with you in this regard."><meta name=twitter:image content="/nebula-website/en/posts/automate-workflows-with-github-action/Autoflow_hu16ce710d63c882d0dae27879a1d9ccfd_1251936_600x0_resize_q75_box.jpg"><meta name=og:image content="/nebula-website/en/posts/automate-workflows-with-github-action/Autoflow_hu16ce710d63c882d0dae27879a1d9ccfd_1251936_600x0_resize_q75_box.jpg"><meta name=description content="Nebula Graph has adopted GitHub Actions to automate testing and releasing workflows like Nightly building and branch release. This post shared some best practices with you in this regard."><meta name=generator content="Hugo 0.65.3"><title>Automate Workflows with Github Action in Nebula Graph</title><link rel="shortcut icon" href=/nebula-website/favicon.ico><link rel=stylesheet href=/nebula-website/css/bootstrap.min.css type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic" rel=stylesheet type=text/css><link rel=stylesheet href=/nebula-website/font-awesome/css/font-awesome.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/creative.css type=text/css><link rel=stylesheet href=/nebula-website/css/modals.css type=text/css><link rel=stylesheet href=/nebula-website/css/animate.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/custom/index.css type=text/css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/nebula-website/js/jquery.js></script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPJVFGH');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-60523578-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-60523578-5');</script></head><body id=page-top><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPJVFGH" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><nav id=mainNav class="navbar navbar-default navbar-fixed-top"><div class=nav-popup id=nav-popup><img src=/images/popup.png><img src=/images/popup.png> Nebula Graph RC4 is released! <a href=https://github.com/vesoft-inc/nebula/releases/tag/v1.0.0-rc4 target=_blank>Get Started</a> <img src=/images/shut.png id=shut onclick=shut()></div><div class=container-fluid><div class=navbar-header><div class=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-icon=octicon-star data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></div><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class="navbar-brand page-scroll" href=/nebula-website/en/></a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav" id=nav><li class=github-star id=github-star onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via Navi'})"><a class=github-button href=https://github.com/vesoft-inc/nebula data-size=large data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></li><li><a href=https://docs.nebula-graph.io/ target=_blank>Docs</a></li><li class=active><a href=/en/posts target>Blog</a></li><li><a href=https://discuss.nebula-graph.io/ target=_blank>Forum</a></li><li><a href=#contact_us target onclick=contactUsClick()>Contact Us</a></li><li class="dropdown navbar-right"><a class=dropdown-toggle data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false><img src=/images/language120x120.png>
<span class=caret></span></a><ul class=dropdown-menu><li class=nav-item><a class=dropdown-item href=/en target>English</a></li><li class=nav-item><a class=dropdown-item href=/cn target>中文</a></li></ul></li><li id=navbar-right><a href=https://github.com/vesoft-inc/nebula-web-docker target=_blank onclick="gtag('event','Button Click',{event_category:'Engagement',event_label:'Nebula Studio'})">Nebula Studio</a></li></ul></div></div></nav><script>function contactUsClick(){$('html,body').animate({scrollTop:document.documentElement.scrollHeight},800)
return false;}
function shut(){$('#nav-popup').remove();$("#top").css("padding-top","50px")
sessionStorage.setItem("popupIsRemove",true);}
if(!sessionStorage.getItem("popupIsRemove")){$("#nav-popup").css("display","block")}</script><main id=top class=blog-detail><div class=wrapper><div class=inner><div class=blog-left-aside><div class=social-share id=J_Share><h3>Share</h3><div class=nebula-share-buttons><div class="st-custom-button st-remove-label" data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg></div><div class="st-custom-button st-remove-label" data-network=linkedin><img alt="linkedin-white sharing button" src=https://platform-cdn.sharethis.com/img/linkedin-white.svg></div><div class="st-custom-button st-remove-label" data-network=facebook><img alt="facebook-white sharing button" src=https://platform-cdn.sharethis.com/img/facebook-white.svg></div><div class="st-custom-button st-remove-label" data-network=hackernews><img alt="hackernews-white sharing button" src=https://platform-cdn.sharethis.com/img/hackernews-white.svg></div><div class="st-custom-button st-remove-label" data-network=reddit><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/reddit-white.svg></div><div class="st-custom-button st-remove-label" data-network=sharethis><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg></div></div></div></div><section class=blog-content><h1>Automate Workflows with Github Action in Nebula Graph</h1><div class=blog-metas><div class=meta><img src=/images/writer.png width=16px height=16px>
<span>Yee</span></div><div class=meta><img src=/images/calendar.png width=16px height=16px>
<span>2020-05-07</span></div><div class="tags meta"><img src=/images/tag.png width=16px height=16px>
<a href=/nebula-website/en//tags/dev-log>dev-log</a></div></div><p><img src=https://user-images.githubusercontent.com/57335825/81528711-34a2cb80-9312-11ea-83ff-a64c6ab16c7c.png alt="Automate Workflows with Github Action in Nebula Graph"></p><h2 id=why-github-action>Why GitHub Action</h2><p>Nebula Graph initially implemented its automated testing with <a href=https://jenkins.io/>Jenkins</a> (built on Azure) and GitHub Webhook. When a pull request is opened, adding a <code>ready-for-testing</code> label together with a comment &ldquo;Jenkins go&rdquo; will automatically trigger the corresponding unit testing process:</p><p><img src=https://user-images.githubusercontent.com/57335825/81528783-556b2100-9312-11ea-941b-8dce580b0083.png alt="unit testing is triggered"></p><p>This solution is not cost-effective because the Azure cloud server is rented while Nebula Graph compilation requires high performance servers.</p><p>So we&rsquo;ve been considering an alternative to Azure cloud server since last year. The new solution must support multi-environment tests, too.</p><p>We&rsquo;ve done some research and found the following candidates:</p><ol><li>TravisCI</li><li>CircleCI</li><li>Azure Pipeline</li><li>Jenkins on k8s (Self-hosted)</li></ol><p>Overall, these products are friendly. There are some restrictions on open source projects, though.</p><p>Given the previous experience of using GitLab CI, we realized that the first choice is a product with deep integration with GitHub, meaning that you can share the entire open source ecosystem of GitHub and call the APIs natively.</p><p>Coincidently, GitHub Action 2.0 was released in 2019. So Nebula Graph became the explorer.</p><p>For us, GitHub Action is awesome in the following ways:</p><ol><li><strong>It&rsquo;s free</strong>. To open source projects, not only the full feature set is available, but it also offers <a href=https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners#supported-runners-and-hardware-resources>high performance machines</a>, for free.</li><li><strong>Perfect open source ecosystem</strong>. All open source actions can be directly used for the entire CI (Continuous Integration) process. It also supports custom actions. GitHub Action supports customization in Docker, which means that you can create a custom action with just bash commands.</li><li><strong>Support multiple systems</strong>. One-click deployment on Windows, MacOS and Linux makes cross-platform operations easier.</li><li><strong>Interaction with GitHub API</strong>. Directly access <a href=https://developer.github.com/v3/>GitHub API V3</a> with <code>GITHUB_TOKEN</code> so that you can upload files, check PR status with the curl command.</li><li><strong>GitHub-hosted runners</strong>. Simply add the workflow description file under the <code>.github/workflows/</code> directory, and each commit will automatically trigger a new action run.</li><li><strong>Workflow description file in YAML</strong>,  which is more concise and readable than the Action 1.0 workflow.</li></ol><p>Before diving into practice details, let&rsquo;s clarify Nebula Graph&rsquo;s primary goal of using GitHub Action, i.e. automated testing.</p><p>Testing cannot be overemphasized for a database solution. In Nebula Graph, testing is mainly divided into unit testing and integration testing. GitHub Action is mainly used for automating unit testing. Meanwhile it is used as a preparation for integration testing, for example Docker image building and installer packaging. Finally it solves the release requirements for the PM lady. In this way, we have built the first version of the CI/CD process.</p><h2 id=pr-test>PR Test</h2><p>As an open source project hosted on GitHub, Nebula Graph must solve the primary testing problem of quickly verifying the changes in a PR committed by a contributor. The following aspects should be taken into consideration:</p><ol><li>Does the code meet our coding style?</li><li>Can the code be compiled on different systems?</li><li>Does it pass all unit tests?</li><li>Has the code coverage dropped?</li></ol><p>Only if all the above requirements are met and there are at least two approvals, the changes can be merged into the master.</p><p>With the help of open source tools such as cpplint or clang-format, requirement #1 can be met easily. If Step1 fails, the following steps will be skipped automatically and the whole process will not be continued.</p><p>For requirement #2, we hope to compile Nebula Graph source code on the currently supported systems. Thus, building directly on the physical machines is no longer a choice. After all, the price of one single machine is rather high, not to mention one machine is not enough. In order to ensure the consistency of the compilation environments and reduce the performance loss as much as possible, we finnally chose Docker. The process went smoothly with GitHub Action&rsquo;s <a href=https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix>job matrix</a> and its support for <a href=https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idcontainer>Docker</a>.</p><p><img src=https://user-images.githubusercontent.com/57335825/81529003-c7dc0100-9312-11ea-9441-2fd611b65819.png alt="pr test processing flow"></p><p>Like shown above, Nebula Graph&rsquo;s compilation image is maintained in <a href=vesoft-inc/nebula-dev-docker>our Docker image project</a>. Changes or upgrade of the compiler or third party dependencies will automatically trigger the Build task of Docker hub (see the figure below). When a new Pull Request is committed, GitHub Action will be triggered to start pulling the latest compilation image and execute the compilation.</p><p><img src=https://user-images.githubusercontent.com/57335825/81529116-02459e00-9313-11ea-808d-2f6653173836.png alt=image></p><p>For a complete description of the PR workflow , see <a href=https://github.com/vesoft-inc/nebula/blob/master/.github/workflows/pull_request.yaml>pull_request.yaml</a>. Meanwhile, considering that not every PR needs to be tested immediately, and the self-hosted machine resources are limited, we&rsquo;ve set the following constraints to the CI trigger:</p><ol><li>Only PRs that pass the lint verification will deliver the subsequent job to the self-hosted runner. The lint task is relatively lightweighted, and can be executed in the machine hosted by GitHub Action, avoiding taking up our own resources.</li><li>Only PRs labeled with <code>ready-for-testing</code> will trigger action execution. While labelling needs authority,  the runner can be triggered by certified pull requests only. See the code below for the PR label restriction:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>jobs</span>:
  <span style=color:#66d9ef>lint</span>:
    <span style=color:#66d9ef>name</span>: cpplint
    <span style=color:#66d9ef>if</span>: contains(join(toJson(github.event.pull_request.labels.<span style=color:#75715e>*.name)),</span> <span style=color:#e6db74>&#39;ready-for-testing&#39;</span>)
</code></pre></div><p>Here&rsquo;s how it looks when a PR passes all the tests:</p><p><img src=https://user-images.githubusercontent.com/57335825/81529179-243f2080-9313-11ea-9b9b-11b669f4336a.png alt="pr passes all checks"></p><p>For details on how Code Coverage is conducted in Nebula Graph, please see <a href=https://nebula-graph.io/en/posts/integrate-codecov-test-coverage-with-nebula-graph/>Integrating Codecov Test Coverage With Nebula Graph</a>.</p><h2 id=nightly-building>Nightly Building</h2><p>Nebula Graph&rsquo;s integrated testing framework requires that all the test cases are run on the code in the codebase every night. In the mean time, we want some new features to be quickly packaged and delivered to users for a test drive. This requires that the CI system provides the Docker image and rpm/deb package of the codebase each day.</p><p>In addition to the pull_request event type, GitHub Action can also be triggered by the <a href=https://help.github.com/en/actions/reference/events-that-trigger-workflows#scheduled-events-schedule>schedule</a> type. Similar to crontab, schedule allows users to specify the trigger time of any repetitive tasks. For example, execute tasks at 2:00AM every day:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>on</span>:
  <span style=color:#66d9ef>schedule</span>:
    - <span style=color:#66d9ef>cron</span>: <span style=color:#e6db74>&#39;0 18 * * *&#39;</span>
</code></pre></div><p>GitHub uses UTC time, so 2:00AM CST is 6:00PM UTC the previous day.</p><h2 id=docker>Docker</h2><p>The daily built Docker image needs to be pushed to the Docker Hub and tagged with the nightly label. Here we set the image pulling method as Always in the k8s cluster for integrate testing. So that the daily request to upgrade Nebula Graph would trigger rolling upgrade to the latest Docker image of the current day, i.e. the nightly version, for integrating test. We are trying our best not to leave problems raised today to tomorrow, there is no additional date tag for the nightly image. See the action details below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#66d9ef>name</span>: Build image
        <span style=color:#66d9ef>env</span>:
          <span style=color:#66d9ef>IMAGE_NAME</span>: ${{ secrets.DOCKER_USERNAME }}/nebula-${{ matrix.service }}:nightly
        <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>          docker build -t ${IMAGE_NAME} -f docker/Dockerfile.${{ matrix.service }} .</span>
          docker push ${IMAGE_NAME}
        <span style=color:#66d9ef>shell</span>: bash
</code></pre></div><h2 id=package>Package</h2><p>GitHub Action provides <a href=https://help.github.com/en/actions/configuring-and-managing-workflows/persisting-workflow-data-using-artifacts>artifacts</a> to allows users to persist data in a workflow. GitHub stores these artifacts for 90 days, which is more than enough for the storage of the nightly installation package. Using the official <code>actions / upload-artifact @ v1</code> action, you can easily upload files in the specified directory to artifacts. Following is how the Nebula Graph nightly package looks like:</p><p><img src=https://user-images.githubusercontent.com/57335825/81529261-5cdefa00-9313-11ea-9cee-b82b64f751ad.png alt=package></p><h2 id=branch-releasing>Branch Releasing</h2><p>For better maitainence and bugfix, Nebula Graph adopts branch release, i.e. we freeze the code before each release and create a new release branch. Only bugfix is allowed on the release branch and feature development is not allowed. The bugfix will still be committed to the development branch, and finally be cherry picked to the release branch.</p><p>At each release, in addition to the source code, we hope to add the installation package to assets for users to download. Doing it manually is both error-prone and time-consuming. GitHub Action is perfect for this. What&rsquo;s more, the packaging and uploading use the internal GitHub network, which is faster.</p><p>After the installation package is compiled, you can directly call the GitHub API through the curl command to upload it to the assets. The <a href=https://github.com/vesoft-inc/nebula/blob/master/ci/scripts/upload-github-release-asset.sh>script</a> looks as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl --silent <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --request POST <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --url <span style=color:#e6db74>&#34;</span>$upload_url<span style=color:#e6db74>?name=</span>$filename<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --header <span style=color:#e6db74>&#34;authorization: Bearer </span>$github_token<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --header <span style=color:#e6db74>&#34;content-type: </span>$content_type<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>     --data-binary @<span style=color:#e6db74>&#34;</span>$filepath<span style=color:#e6db74>&#34;</span>
</code></pre></div><p>At the same time, for the sake of security, every time the installation package is released, we want to calculate its checksum value and upload the value to the assets for user&rsquo;s convenience for integrity check after downloading. The steps are as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>jobs</span>:
  <span style=color:#66d9ef>package</span>:
    <span style=color:#66d9ef>name</span>: package and upload release assets
    <span style=color:#66d9ef>runs-on</span>: ubuntu-latest
    <span style=color:#66d9ef>strategy</span>:
      <span style=color:#66d9ef>matrix</span>:
        <span style=color:#66d9ef>os</span>:
          - ubuntu1604
          - ubuntu1804
          - centos6
          - centos7
    <span style=color:#66d9ef>container</span>:
      <span style=color:#66d9ef>image</span>: vesoft/nebula-dev:${{ matrix.os }}
    <span style=color:#66d9ef>steps</span>:
      - <span style=color:#66d9ef>uses</span>: actions/checkout@v1
      - <span style=color:#66d9ef>name</span>: package
        <span style=color:#66d9ef>run</span>: ./package/package.sh
      - <span style=color:#66d9ef>name</span>: vars
        <span style=color:#66d9ef>id</span>: vars
        <span style=color:#66d9ef>env</span>:
          <span style=color:#66d9ef>CPACK_OUTPUT_DIR</span>: build/cpack_output
          <span style=color:#66d9ef>SHA_EXT</span>: sha256sum.txt
        <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>          tag=$(echo ${{ github.ref }} | rev | cut -d/ -f1 | rev)</span>
          cd $CPACK_OUTPUT_DIR
          filename=$(find . -type f \( -iname \<span style=color:#75715e>*.deb</span> -o -iname \<span style=color:#75715e>*.rpm</span> \) -exec basename {} \;)
          sha256sum $filename &gt; $filename.$SHA_EXT
          echo <span style=color:#e6db74>&#34;::set-output name=tag::$tag&#34;</span>
          echo <span style=color:#e6db74>&#34;::set-output name=filepath::$CPACK_OUTPUT_DIR/$filename&#34;</span>
          echo <span style=color:#e6db74>&#34;::set-output name=shafilepath::$CPACK_OUTPUT_DIR/$filename.$SHA_EXT&#34;</span>
        <span style=color:#66d9ef>shell</span>: bash
      - <span style=color:#66d9ef>name</span>: upload release asset
        <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>          ./ci/scripts/upload-github-release-asset.sh github_token=${{ secrets.GITHUB_TOKEN }} repo=${{ github.repository }} tag=${{ steps.vars.outputs.tag }} filepath=${{ steps.vars.outputs.filepath }}</span>
          ./ci/scripts/upload-github-release-asset.sh github_token=${{ secrets.GITHUB_TOKEN }} repo=${{ github.repository }} tag=${{ steps.vars.outputs.tag }} filepath=${{ steps.vars.outputs.shafilepath }}
</code></pre></div><p>See <a href=https://github.com/vesoft-inc/nebula/blob/master/.github/workflows/release.yaml>release.yaml</a> for the complete workflow file.</p><h2 id=commands>Commands</h2><p>GitHub Action provides some <a href=https://help.github.com/en/actions/reference/workflow-commands-for-github-actions>Shell commands</a> so that you can control and debug each workflow step in greater granularity right in the your Shell console. Some commonly used commands are explained below.</p><h3 id=set-outputsetting-an-output-parameter>set-output: Setting an output parameter</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>::set-output name={name}::{value}
</code></pre></div><p>Sometimes you need to pass some results among job steps. You can set the <code>output_value</code> to the <code>output_name</code> variable via command <code>echo "::set-output name=output_name::output_value"</code>.</p><p>In the following steps, you can refer to the above output value via <code>${{ steps.step_id.outputs.output_name }}</code>.</p><p>This method is used In the job to upload assets mentioned in the previous section. One step can set multiple outputs by executing the above command multiple times.</p><h3 id=set-envsetting-an-environment-variable>set-env: Setting an environment variable</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>::set-env name={name}::{value}
</code></pre></div><p>Similar to <code>set-output</code>, you can create an environment variable for subsequent steps in the current job. Syntax: <code>echo "::set-env name={name}::{value}"</code>.</p><h3 id=add-pathadding-a-system-path>add-path: Adding a system path</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>::add-path::{path}
</code></pre></div><p>This command is to prepend a directory to the system PATH variable for all subsequent steps in the current job. Syntax: <code>echo "::add-path::{path}"</code>.</p><h2 id=self-hosted-runner>Self-Hosted Runner</h2><p>In addition to GitHub-hosted runners, Action also allows you to host runner on your own machine. After installing the Action Runner on the machine, follow the <a href=https://help.github.com/en/actions/hosting-your-own-runners/adding-self-hosted-runners>tutorial</a> to add it to your repository, and configure <code>runs-on: self-hosted</code> in the workflow file. You are all set.</p><p>You can assign different <a href=https://help.github.com/en/actions/hosting-your-own-runners/using-labels-with-self-hosted-runners>labels</a> to your self-hosted machines. In this way, you can distribute tasks to a machine with a specific label. For example, if your machines run on different operation systems, then a job can be assigned to a <a href=https://help.github.com/en/actions/hosting-your-own-runners/using-self-hosted-runners-in-a-workflow>specified machine</a> based on the <code>runs-on</code> label.</p><p><img src=https://user-images.githubusercontent.com/57335825/81529444-b6472900-9313-11ea-902b-8ee5f204daed.png alt="runs-on label"></p><h3 id=security-enhancements>Security Enhancements</h3><p>GitHub does not recommend self-hosted runners for open source projects because anyone can attack the runner machine by committing a PR with dangerous code.</p><p>However, Nebula Graph compilation requires a larger storage than GitHub&rsquo;s two-core environment , which leaves us with no choice other than self-host runners. To ensure security, we have done the following:</p><h4 id=deployment-on-vm>Deployment on VM</h4><p>All runners registered to GitHub Action are deployed in virtual machines, which can isolate the host machine and make it easier to allocate resources among virtual machines. A high performance host machine can allocate multiple virtual machines to run all the received tasks in parallel.</p><p>If there is a problem with the virtual machines, you can easily restore the environment.</p><h4 id=network-isolation>Network Isolation</h4><p>We have isolated all the virtual machines that hold the runner from the office network to avoid direct access to our internal resources. Even if a PR contains malicious code, it can&rsquo;t access our internal network for further attacks.</p><h4 id=choose-the-right-action>Choose the Right Action</h4><p>Try to choose actions from well-known companies or official releases. If you are using the works of individual developers, you&rsquo;d better check their implementation code to avoid being victims of <a href=https://julienrenaux.fr/2019/12/20/github-actions-security-risk/>privacy keys leakage </a>.</p><p>Here is the <a href=https://github.com/actions>list</a> of official actions provided by GitHub.</p><h4 id=private-token-verification>Private Token Verification</h4><p>GitHub Action will automatically check whether there are private tokens in a PR. No private tokens (refereed to with <code>${{ secrets.MY_TOKENS }}</code>), except <code>GITHUB_TOKEN</code> , can be used in a PR event triggered job to prevent users from stealing tokens by printing it out privately through PR.</p><h3 id=environment-building-and-clearing>Environment Building and Clearing</h3><p>For self-hosted runners, it is convenient to share files between different jobs. But don’t forget to clean up the intermediate files each time after the entire action is executed, otherwise they may affect the following jobs and occupy disk space.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#66d9ef>name</span>: Cleanup
        <span style=color:#66d9ef>if</span>: always()
        <span style=color:#66d9ef>run</span>: rm -rf build
</code></pre></div><p>Set the running condition of step to <code>always ()</code> to ensure that the cleanup is executed every time, even if something goes wrong during execution.</p><h3 id=parallel-building-based-on-docker-matrix>Parallel Building Based on Docker Matrix</h3><p>We chose to build Nebula Graph with container because it needs to compile and verify on various operation systems and container makes it easy to separate environments. GitHub Action natively supports Docker based tasks.</p><p>GitHub Action supports the matrix strategy to run tasks, which is similar to TravisCI&rsquo;s <a href=https://docs.travis-ci.com/user/build-matrix/>build matrix</a>. By combining systems and compilers, we can easily use gcc and clang in each system to compile the source code of Nebula Graph. Matrix example is shown as below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>jobs</span>:
  <span style=color:#66d9ef>build</span>:
    <span style=color:#66d9ef>name</span>: build
    <span style=color:#66d9ef>runs-on</span>: ubuntu-latest
    <span style=color:#66d9ef>strategy</span>:
      <span style=color:#66d9ef>fail-fast</span>: <span style=color:#66d9ef>false</span>
      <span style=color:#66d9ef>matrix</span>:
        <span style=color:#66d9ef>os</span>:
          - centos6
          - centos7
          - ubuntu1604
          - ubuntu1804
        <span style=color:#66d9ef>compiler</span>:
          - gcc<span style=color:#ae81ff>-9.2</span>
          - clang<span style=color:#ae81ff>-9</span>
        <span style=color:#66d9ef>exclude</span>:
          - <span style=color:#66d9ef>os</span>: centos7
            <span style=color:#66d9ef>compiler</span>: clang<span style=color:#ae81ff>-9</span>
</code></pre></div><p>The above strategy generates 8 parallel tasks (4 OS x 2 compiler). Each task is a combination of an OS and a compiler. This greatly reduces the workload of manual definition for different dimensions.</p><p>Exclude a certain combination in the matrix by adding it to the <code>exclude</code> option. If you want to access the value in the matrix in the task, you can get it by obtaining the value of the context variable like <code>$ {{matrix.os}}</code>. These methods make it very convenient to customize your tasks.</p><h4 id=runtime-container>Runtime Container</h4><p>We can specify a container environment for each task at runtime, so that all steps of the task will be executed in the container&rsquo;s internal environment. Compared to applying the docker command in each step, this is simpler and clearer.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#66d9ef>container</span>:
      <span style=color:#66d9ef>image</span>: vesoft/nebula-dev:${{ matrix.os }}
      <span style=color:#66d9ef>env</span>:
        <span style=color:#66d9ef>CCACHE_DIR</span>: /tmp/ccache/${{ matrix.os }}-${{ matrix.compiler }}
</code></pre></div><p>For container configuration, like configuring service in Docker compose, you can specify image/env/ports/volumes/options and other <a href=https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idcontainer>parameters</a>. In the self-hosted runner, you can easily mount the directory on the host machine to the container for file sharing.</p><p>It is the container characteristics of GitHub Action that make it convenient to accelerate subsequent compilation via cache in Docker.</p><h2 id=compilation-acceleration>Compilation Acceleration</h2><p>The source code of Nebula Graph is written in C++, and the construction process is rather time consuming. Restarting CI every time will cause waste of computing resources. So as long as the source code isn&rsquo;t updated, the compiled file will be cached for accelaration. Currently we use the latest version of ccache for <a href=https://ccache.dev/>cache</a> purpose. It also help identify whether a source file has been updated or not by looking precisely into the compiling process of the file.</p><p>Although GitHub Action itself provides the <a href=https://help.github.com/en/actions/configuring-and-managing-workflows/caching-dependencies-to-speed-up-workflows>cache</a> function, we go for the local cache strategy because Nebula Graph currently uses static linking for unit test use cases and its size after compilation exceeds the quota assaigned by GitHub Action cache.</p><h3 id=ccache>ccache</h3><p><a href=https://ccache.dev/>ccache</a> is a compiler cache tool. It speeds up compilation by caching previous compilations and supporting compilers like gcc/clang. Nebula Graph adopts the C++ 14 standard which has compatibility issues with lower version ccache, so ccache in all <code>vesoft/nebula-dev</code> <a href=https://github.com/vesoft-inc/nebula-dev-docker>images</a> is\ manually compiled and installed.</p><p>Nebula Graph automatically detects whether ccache is installed in the cmake configuration and decides whether to enable it. So you only configure ccache in the container environment. For example, configure the maximum cache capacity in <a href=https://github.com/vesoft-inc/nebula/blob/master/ci/ccache.conf>ccache.conf</a> as 1 Gigabyte. When cache surpasses the threshold, the older cache is automatically replaced.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>max_size = <span style=color:#ae81ff>1.</span>0G
</code></pre></div><p>We suggest you put the <code>ccache.conf</code> configuration file under the cache directory so that ccache can read the file conveniently.</p><h3 id=tmpfs>tmpfs</h3><p>tmpfs is a temporary file system located in the memory or swap partition, which can effectively alleviate the delay caused by disk IO. Because the memory of self-hosted machine is sufficient, the ccache directory mount type is changed to tmpfs to reduce ccache read and write time . For using tmpfs mounting type in Docker, please refer to the <a href=https://docs.docker.com/storage/tmpfs/>Use tmpfs mounts</a> documentation. The corresponding configuration parameters are as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#66d9ef>env</span>:
      <span style=color:#66d9ef>CCACHE_DIR</span>: /tmp/ccache/${{ matrix.os }}-${{ matrix.compiler }}
    <span style=color:#66d9ef>options</span>: --mount type=tmpfs,destination=/tmp/ccache,tmpfs-size=<span style=color:#ae81ff>1073741824</span> -v /tmp/ccache/${{ matrix.os }}-${{ matrix.compiler }}:/tmp/ccache/${{ matrix.os }}-${{ matrix.compiler }}
</code></pre></div><p>Place all cache files generated by ccache in a directory that mounting as a tmpfs type.</p><h3 id=parallel-compilation>Parallel Compilation</h3><p>The make process itself supports parallel compilation of multiple source files. Configuring<code>-j $(nproc)</code> during compilation will enable the same number of tasks as the number of cores. Configure the steps in action as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#66d9ef>name</span>: Make
        <span style=color:#66d9ef>run</span>: cmake --build build/ -j $(nproc)
</code></pre></div><h2 id=things-to-improve>Things to Improve</h2><p>We&rsquo;ve talked a lot about the advantages and strongness of GitHub Action, but are there drawbacks? After spending some time using it, below are some thoughts to share with you:</p><ol><li><strong>Only support systems of newer versions</strong>. Many actions are developed based on newer Node.js versions and cannot be used directly in old Docker containers like CentOS 6.It will throw an error &lsquo;the library file that Nodejs depends on cannot be found&rsquo;. Thus action cannot be started properly. Since Nebula Graph also supports CentOS 6, the tasks in this system have to be handled differently.</li><li><strong>It is not easy to verify locally</strong>. Although there is an open source project <a href=https://github.com/nektos/act>act</a> in the community, there are still many restrictions according to our experiences. Sometimes you have to repeatedly commit in your own repository to ensure the action modification is correct.</li><li><strong>Lacking guidelines currently</strong>. When customizing numerous tasks, it feels like coding in the YAML configuration.
There are currently three main approaches:
a. Split the configuration files based on tasks.
b. Customize action via GitHub SDK.
c. Write a long shell script to complete the tasks and call the script in your tasks.</li></ol><p>So far it&rsquo;s still under debate in the community which approach is better, combination of small tasks or big tasks. According to my personal experience, the approach to combine small tasks helps easily locate task failure and determine the execution time of each step.</p><p><img src=https://user-images.githubusercontent.com/57335825/81529770-6c127780-9314-11ea-961d-7f845d043b0f.png alt="group small tasks"></p><ol start=4><li><strong>Part of the action history cannot be cleaned up</strong>. If the workflow name is changed, the old check runs record will still remain in the action page, affecting the user experience.</li><li><strong>Lacking manual job/task trigger similar to GitLab CI</strong>. No manual intervention is allowed during action execution.</li><li><strong>The development of action is under constant iteration</strong>. Sometimes it is necessary to maintain an upgrade, for example, <a href=https://github.com/actions/checkout/issues/23>checkout@v2</a>.</li></ol><p>But overall, GitHub Action is an awesome CI/CD system. After all, as a product that stands on the shoulders of predecessors such as GitLab  CI/Travis CI, there are a lot to learn from.</p><h2 id=whats-next>What&rsquo;s Next</h2><h3 id=customized-action>Customized Action</h3><p>A while ago, Docker has released its first <a href=https://www.docker.com/blog/first-docker-github-action-is-here/>Action</a> to simplify the Docker related tasks. In the future, we will also customize our own actions dealing with the complex CI/CD requirements and enable them in all Nebula repositories.</p><p>For some general ones like appending assets to the release function, we will put them in an independent repository and publish them in the action marketplace. The exclusive onces will be placed in the <code>.github/actions</code> directory of each repository.</p><p>This simplifies the YAML configuration in workflows, you only need to use a customized action which has better flexibility and expandability.</p><h3 id=integration-with-im-dingtalkslack>Integration with IM (DingTalk/Slack)</h3><p>You can develop complex action applications through the GitHub SDK and combine it with the customization bots of IM tools like DingTalk and Slack to realize a lot of automated and interesting applications.</p><p>For example, when a PR is approved by more than two reviewers and all check runs are passed, you can send a message to a DingTalk group and tag someone to merge them. This saves engineers from checking every PR state in the PR list.</p><p>Any ideas how to play around GitHun Action? Leave a comment below and let&rsquo;s talk!</p><h2 id=you-might-also-like>You might also like:</h2><ol><li><a href=https://nebula-graph.io/en/posts/github-action-automating-project-process/>Automating Your Project Processes with Github Actions</a></li><li><a href=https://nebula-graph.io/en/posts/practice-jepsen-test-framework-in-nebula-graph/>Practice Jepsen Test Framework in Nebula Graph</a></li><li><a href=https://nebula-graph.io/en/posts/integrate-codecov-test-coverage-with-nebula-graph/>Integrating Codecov Test Coverage With Nebula Graph</a></li></ol><blockquote><p>Hi, I&rsquo;m Yee, engineer at Nebula Graph. I&rsquo;m interested in database query engine and would like to share my experiences in this regard. Hope my post is of help to you. Please let me know if you have any ideas about this. Thanks!</p></blockquote><blockquote class=star-ads><span>Like what we do ? Star us on GitHub.</span>
<a href=https://github.com/vesoft-inc/nebula onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'Star via blogbody'});">https://github.com/vesoft-inc/nebula</a></blockquote><ul class=blog-footer><li><img src=/images/tag.png>
<a href=/nebula-website/en/tags/dev-log>dev-log</a></li><li class="nebula-share st-btn"><img src=/images/share.png>
<span>Share</span><ul class=blog-footer-share-links><li class=st-custom-button data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg>
<span class=st-label>Twitter</span></li><li class=st-custom-button data-network=linkedin><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/linkedin-white.svg>
<span class=st-label>Linkedin</span></li><li class=st-custom-button data-network=facebook><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/facebook-white.svg>
<span class=st-label>Facebook</span></li><li class=st-custom-button data-network=sharethis><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg>
<span class=st-label>Others</span></li></ul></li><li onclick="location.href='\/nebula-website\/en\/posts'"><img src=/images/blog.png>
<a href=/nebula-website/en/posts>Back to blog home</a></li><li onclick="gtag('event','Link Click',{event_category:'Engagement',event_label:'RSS via blogbody'});window.open('https:\/\/nebula-graph.io/en/posts/index.xml');"><img src=/images/rss.png>
<a href=javascript:void(0);>RSS</a></li></ul><div id=discourse-comments></div></section><div class=single-side-bar><div class=tags-block><h3><img src=/img/LabelTagIcon.png>Tags</h3><ul class=blog-tags><li class=col-md-12><a href=/nebula-website/en/posts class=active>all</a></li><li><a href=/nebula-website/en/tags/architecture>architecture</a></li><li><a href=/nebula-website/en/tags/community>community</a></li><li><a href=/nebula-website/en/tags/deployment>deployment</a></li><li><a href=/nebula-website/en/tags/dev-log class=active>dev-log</a></li><li><a href=/nebula-website/en/tags/features>features</a></li><li><a href=/nebula-website/en/tags/graph-database>graph-database</a></li><li><a href=/nebula-website/en/tags/performance>performance</a></li><li><a href=/nebula-website/en/tags/query-language>query-language</a></li><li><a href=/nebula-website/en/tags/release-notes>release-notes</a></li><li><a href=/nebula-website/en/tags/system-testing>system-testing</a></li><li><a href=/nebula-website/en/tags/tools>tools</a></li><li><a href=/nebula-website/en/tags/use-cases>use-cases</a></li></ul></div><div class=blog-anchors id=J_Anchor><h3>Contents</h3><nav id=TableOfContents><ul><li><a href=#why-github-action>Why GitHub Action</a></li><li><a href=#pr-test>PR Test</a></li><li><a href=#nightly-building>Nightly Building</a></li><li><a href=#docker>Docker</a></li><li><a href=#package>Package</a></li><li><a href=#branch-releasing>Branch Releasing</a></li><li><a href=#commands>Commands</a><ul><li><a href=#set-outputsetting-an-output-parameter>set-output: Setting an output parameter</a></li><li><a href=#set-envsetting-an-environment-variable>set-env: Setting an environment variable</a></li><li><a href=#add-pathadding-a-system-path>add-path: Adding a system path</a></li></ul></li><li><a href=#self-hosted-runner>Self-Hosted Runner</a><ul><li><a href=#security-enhancements>Security Enhancements</a></li><li><a href=#environment-building-and-clearing>Environment Building and Clearing</a></li><li><a href=#parallel-building-based-on-docker-matrix>Parallel Building Based on Docker Matrix</a></li></ul></li><li><a href=#compilation-acceleration>Compilation Acceleration</a><ul><li><a href=#ccache>ccache</a></li><li><a href=#tmpfs>tmpfs</a></li><li><a href=#parallel-compilation>Parallel Compilation</a></li></ul></li><li><a href=#things-to-improve>Things to Improve</a></li><li><a href=#whats-next>What&rsquo;s Next</a><ul><li><a href=#customized-action>Customized Action</a></li><li><a href=#integration-with-im-dingtalkslack>Integration with IM (DingTalk/Slack)</a></li></ul></li><li><a href=#you-might-also-like>You might also like:</a></li></ul></nav></div></div></div><img onclick="location.href='#top'" class=go-ahead src=/images/up.png></div><footer class="container-fluid foot-wrap" name=contact_us><div class=container><div class=row><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Community</h3><ul><li><img src=/img/github.png>
<a href=https://github.com/vesoft-inc/nebula target=_blank>GitHub</a></li><li><img src=/img/forum.png>
<a href=https://discuss.nebula-graph.io/ target=_blank>Forum</a></li><li><img src=/img/slack.png>
<a href=https://join.slack.com/t/nebulagraph/shared_invite/enQtNjIzMjQ5MzE2OTQ2LTM0MjY0MWFlODg3ZTNjMjg3YWU5ZGY2NDM5MDhmOGU2OWI5ZWZjZDUwNTExMGIxZTk2ZmQxY2Q2MzM1OWJhMmY# target=_blank>Slack</a></li></ul></div><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Follow Us</h3><ul><li><img src=/img/twitter.png>
<a href=https://twitter.com/NebulaGraph title=Twitter data-toggle=modal target=_blank data-target>Twitter</a></li><li><img src=/img/linkedin.png>
<a href=https://www.linkedin.com/company/vesoft-nebula-graph/ title=LinkedIn data-toggle=modal target=_blank data-target>LinkedIn</a></li><li><img src=/img/youtube.png>
<a href=https://www.youtube.com/channel/UC73V8q795eSEMxDX4Pvdwmw title=YouTube data-toggle=modal target=_blank data-target>YouTube</a></li><li><img src=/img/facebook.png>
<a href=https://www.facebook.com/NebulaGraph/ title=FaceBook data-toggle=modal target=_blank data-target>FaceBook</a></li><li><img src=/img/weibo.png>
<a href=https://weibo.com/nebulagraph title=WeiBo data-toggle=modal target=_blank data-target>WeiBo</a></li><li><img src=/img/gongzhonghao.png>
<a href title="Official Accounts" data-toggle=modal target=_blank data-target=#myGongzhonghaoModal>Official Accounts</a></li></ul></div><div class="contactus row-content col-lg-4 col-sm-4 col-xs-4"><h3>Contact Us</h3><ul><li><img src=/img/iphone.png>
<a href data-toggle=modal target=_blank data-target>(+86) 0571-28120658</a></li><li><img src=/img/email.png>
<a href=mailto:info@vesoft.com data-toggle=modal target=_blank data-target>info@vesoft.com</a></li><li><img src=/img/weixin.png>
<a href data-toggle=modal target=_blank data-target=#myModal>WeChat</a></li></ul></div></div></div><p align=left style=font-size:16px><img src=/images/VEsoft.png style=margin-right:10px> Copyright &copy;2020 VESoft Inc</p><div class="modal fade" id=myGongzhonghaoModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/gonggonghaoCODE.jpg></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div><div class="modal fade" id=myModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/wechat.png></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div></footer></main><script src=/nebula-website/js/jquery.js></script><script src=/nebula-website/js/bootstrap.min.js></script><script src=/nebula-website/js/jquery.easing.min.js></script><script src=/nebula-website/js/jquery.fittext.js></script><script src=/nebula-website/js/wow.min.js></script><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=5e7c2cc315c7990012ae38bc&product=inline-share-buttons" async></script><script src=/nebula-website/js/creative.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script src=/nebula-website/js/init.js></script><script type=text/javascript>DiscourseEmbed={discourseUrl:'https://discuss.nebula-graph.io/',discourseEmbedUrl:"\/nebula-website\/en\/posts\/automate-workflows-with-github-action\/"};(function(){var d=document.createElement('script');d.type='text/javascript';d.async=true;d.src=DiscourseEmbed.discourseUrl+'javascripts/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(d);})();</script><script src=/nebula-website/js/anchor.js></script></body></html><script>if(!sessionStorage.getItem("popupIsRemove")){$("#top").css("padding-top","98px")}</script>