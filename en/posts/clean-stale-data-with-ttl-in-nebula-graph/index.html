<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Nebula Graph"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@NebulaGraph"><meta name=twitter:creator content="@NebulaGraph"><meta name=twitter:domain content="nebula-graph.io"><meta name=twitter:title content="How Nebula Graph Automatically Cleans Stale Data with TTL"><meta property="twitter:title" content="How Nebula Graph Automatically Cleans Stale Data with TTL"><meta name=twitter:description content="Stored procedures and events are commonly used to clean outdated data in databases. Nebula Graph has adopted a more efficient way, i.e. TTL, to automatically clean stale data."><meta name=og:description content="Stored procedures and events are commonly used to clean outdated data in databases. Nebula Graph has adopted a more efficient way, i.e. TTL, to automatically clean stale data."><meta name=twitter:image content="/nebula-website/en/posts/clean-stale-data-with-ttl-in-nebula-graph/Medium%20_hu3748b6c33cc078a5c54e3ea0b9e253e9_2386474_600x0_resize_box_2.png"><meta name=og:image content="/nebula-website/en/posts/clean-stale-data-with-ttl-in-nebula-graph/Medium%20_hu3748b6c33cc078a5c54e3ea0b9e253e9_2386474_600x0_resize_box_2.png"><meta name=description content="Stored procedures and events are commonly used to clean outdated data in databases. Nebula Graph has adopted a more efficient way, i.e. TTL, to automatically clean stale data."><meta name=generator content="Hugo 0.65.3"><title>How Nebula Graph Automatically Cleans Stale Data with TTL</title><link rel="shortcut icon" href=/nebula-website/favicon.ico><link rel=stylesheet href=/nebula-website/css/bootstrap.min.css type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic" rel=stylesheet type=text/css><link rel=stylesheet href=/nebula-website/font-awesome/css/font-awesome.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/creative.css type=text/css><link rel=stylesheet href=/nebula-website/css/modals.css type=text/css><link rel=stylesheet href=/nebula-website/css/animate.min.css type=text/css><link rel=stylesheet href=/nebula-website/css/custom/index.css type=text/css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/nebula-website/js/jquery.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-60523578-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-60523578-5');</script></head><body id=page-top><nav id=mainNav class="navbar navbar-default navbar-fixed-top"><div class=nav-popup id=nav-popup><img src=/images/popup.png><img src=/images/popup.png> Nebula Graph RC4 is released! <a href=https://github.com/vesoft-inc/nebula/releases/tag/v1.0.0-rc4 target=_blank>Get Started</a> <img src=/images/shut.png id=shut onclick=shut()></div><div class=container-fluid><div class=navbar-header><div class=github-star><a class=github-button href=https://github.com/vesoft-inc/nebula data-icon=octicon-star data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></div><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class="navbar-brand page-scroll" href=/nebula-website/en/></a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav" id=nav><li class=github-star id=github-star><a class=github-button href=https://github.com/vesoft-inc/nebula data-size=large data-show-count=true aria-label="Star vesoft-inc/nebula on GitHub">Star</a></li><li><a href=https://docs.nebula-graph.io/ target=_blank>Docs</a></li><li class=active><a href=/en/posts target>Blog</a></li><li><a href=https://discuss.nebula-graph.io/ target=_blank>Forum</a></li><li><a href=#contact_us target onclick=contactUsClick()>Contact Us</a></li><li class="dropdown navbar-right"><a class=dropdown-toggle data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false><img src=/images/language120x120.png>
<span class=caret></span></a><ul class=dropdown-menu><li class=nav-item><a class=dropdown-item href=/en target>English</a></li><li class=nav-item><a class=dropdown-item href=/cn target>中文</a></li></ul></li><li id=navbar-right><a href=https://github.com/vesoft-inc/nebula-web-docker target=_blank>Nebula Studio</a></li></ul></div></div></nav><script>function contactUsClick(){$('html,body').animate({scrollTop:document.documentElement.scrollHeight},800)
return false;}
function shut(){$('#nav-popup').remove();$("#top").css("padding-top","50px")
sessionStorage.setItem("popupIsRemove",true);}
if(!sessionStorage.getItem("popupIsRemove")){$("#nav-popup").css("display","block")}</script><main id=top class=blog-detail><div class=wrapper><div class=inner><section class=blog-content><h1>How Nebula Graph Automatically Cleans Stale Data with TTL</h1><div class=blog-metas><div class=meta><img src=/images/writer.png width=16px height=16px>
<span>Pandasheep</span></div><div class=meta><img src=/images/calendar.png width=16px height=16px>
<span>2020-03-24</span></div><div class="tags meta"><img src=/images/tag.png width=16px height=16px>
<a href=/nebula-website/en//tags/features>features</a></div></div><p><img src=https://user-images.githubusercontent.com/38887077/77512987-09256800-6eaf-11ea-9b41-e8b87ab51fe8.png alt=image></p><h2 id=introduction>Introduction</h2><p>In the era of big data, we are processing data in TB, PB, or even EB. How to deal with huge data sets is a common problem for those working in the database field.</p><p>At the core of  this problem is whether the data stored in the database is still valid and useful. Therefore, such topics as how to improve the utilization rate of valid data and filter the invalid/outdated data have attracted great concerns globally.</p><p>In this post we will focus on how to deal with outdated data in database.</p><p>There are various methods to clean outdated data in database, such as stored procedures, events and so on. Here we will give an example to briefly explain the commonly used stored procedure events as well as TTL in data filtering.</p><h2 id=stored-procedures-and-events>Stored Procedures and Events</h2><h3 id=stored-procedures>Stored Procedures</h3><p>Stored procedures are a collection of one or more SQL statements. This technique encapsulates the complex operations into a code block for code reusing when a series of read or write operations are performed on the database, saving time and effort greatly for database developers.</p><p>Usually once compiled, stored procedures can be executed multiple times, thus greatly improving efficiency.</p><p>Advantages of stored procedures:</p><ul><li><strong>Simplified operations.</strong> Encapsulating the duplicate operations into a stored procedure, which simplifies calls to these SQL queries.</li><li><strong>Batch processing.</strong> The combination of SQL jobs can reduce the traffic between server and client side.</li><li><strong>Unified interface</strong> ensures data security.</li><li><strong>Once compiled, run anywhere</strong> improves the efficiency.</li></ul><p>Take MySQL as an example, assume we want to delete the table as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; SHOW CREATE TABLE person;
+--------+---------------------------------------------------------------------------------------------------------------------------------+
| Table  | Create Table                                                                                                                    |
+--------+---------------------------------------------------------------------------------------------------------------------------------+
| person | CREATE TABLE <span style=color:#e6db74>`</span>person<span style=color:#e6db74>`</span> <span style=color:#f92672>(</span>
  <span style=color:#e6db74>`</span>age<span style=color:#e6db74>`</span> int<span style=color:#f92672>(</span>11<span style=color:#f92672>)</span> DEFAULT NULL,
  <span style=color:#e6db74>`</span>inserttime<span style=color:#e6db74>`</span> datetime DEFAULT NULL
<span style=color:#f92672>)</span> ENGINE<span style=color:#f92672>=</span>InnoDB DEFAULT CHARSET<span style=color:#f92672>=</span>utf8 |
+--------+---------------------------------------------------------------------------------------------------------------------------------+
<span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</code></pre></div><p>This is a table named person, where the <em>inserttime</em> column is a datetime type. And we use the <em>inserttime</em> column to store the generatition time of the data.</p><p>Next, we create a stored procedure that deletes this table:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; delimiter //

mysql&gt; CREATE PROCEDURE del_data<span style=color:#f92672>(</span>IN <span style=color:#e6db74>`</span>date_inter<span style=color:#e6db74>`</span> int<span style=color:#f92672>)</span>
    -&gt; BEGIN
    -&gt;   DELETE FROM person WHERE inserttime &lt; date_sub<span style=color:#f92672>(</span>curdate<span style=color:#f92672>()</span>, interval date_inter day<span style=color:#f92672>)</span>;
    -&gt; END //

mysql&gt; delimiter ;
</code></pre></div><p>The example creates a stored procedure called <em>del_data</em>, where parameter <em>date_inter</em> specifies the interval between the deletion time and current time, i.e. if the sum of the inserttime column (datetime type) and the date_inter is less than the current time, the data is expired and then deleted.</p><h3 id=events>Events</h3><p>Events are tasks that run according to a schedule. An event can be invoked either once or repeatedly. A special thread called event scheduler  executes all scheduled events.</p><p>An event is similar to a trigger as they both run when a specific condition is met. A trigger runs when a statement in database is executed while an event listens to its scheduler. Due to the similarity, events are also called temporary triggers. An event can be scheduled every second.</p><p>The following example creates a recurrent event that invokes the <em>del_data</em>  stored procedure at 12:00:00 everyday to clean data since 2020-03-20.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; CREATE EVENT del_event  
    -&gt;     ON SCHEDULE
    -&gt;     EVERY <span style=color:#ae81ff>1</span> DAY
    -&gt;     STARTS <span style=color:#e6db74>&#39;2020-03-20 12:00:00&#39;</span>
    -&gt;     ON COMPLETION PRESERVE ENABLE
    -&gt;     DO CALL del_data<span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>;
</code></pre></div><p>Then run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; SET global event_scheduler <span style=color:#f92672>=</span> 1;
</code></pre></div><p>Turn on the event del_event so that it will automatically execute in the background at the specified time. Through  stored procedure del_data and event del_event, the expired data is cleaned automatically.</p><h2 id=cleaning-data-via-ttl>Cleaning Data via TTL</h2><p>The above section introduces  cleaning data periodically via the combination of stored procedures and events. However Nebula Graph provides a <strong>simple and efficient way</strong> to automatically clean the expired data, i.e. the TTL method.</p><p>The benefits of using TTL to clean the expired data are as follows:</p><ol><li>Easy and convenient.</li><li>Ensured security and reliability by processing through the internal logic of the database system.</li><li>Highly automated. The database automatically judges and performs when to process according to its own status. No manual intervention is needed.</li></ol><h2 id=introduction-to-ttl>Introduction to TTL</h2><p><a href=https://en.wikipedia.org/wiki/Time_to_live>Time to Live</a> (TTL for short) is a mechanism that allows you to automatically delete expire data. TTL determines the data life cycle in databases.</p><p>In Nebula Graph, data that reaches its expiration can no longer be retrieved, and will be removed within certain future.</p><p>The system will automatically delete the expired data from disk during a background garbage collection operation called compaction. Before being deleted from the disk, all  expired data have been invisible to the user.</p><p>TTL requires two parameters, <code>ttl_col</code> and <code>ttl_duration</code>. <code>ttl_col</code> indicates the  TTL column, while <code>ttl_duration</code> indicates the time duration of  TTL. When the sum of the TTL column and the ttl_duration is less than current time, the data is expired. The <code>ttl_col</code> type must be either integer or timestamp, and is considered in seconds. <code>ttl_duration</code> <strong>must</strong> also be set in seconds.</p><h2 id=ttl-read-filtering>TTL Read Filtering</h2><p>As mentioned earlier, TTLed records are invisible to users. And therefore it is a waste to transfer these records from storage server to graph service through network.  In the Nebula Graph storage service, the TTL information is obtained from meta service first, and then the ttl_col value is checked for every vertex or edge upon graph traversing, i.e. the system compares the sum of the TTL column and the ttl_duration with the current time, finds the expired data then filters them.</p><h2 id=ttl-compaction-details>TTL Compaction Details</h2><h3 id=background-rocksdb-file-organizations>Background: RocksDB file organizations</h3><p>Nebula Graph uses RocksDB as its storage engine. The RocksDB files on disk are organized in multiple levels. By default there are seven levels.</p><p><img src=https://user-images.githubusercontent.com/38887077/77512928-ed21c680-6eae-11ea-92b5-41877f3ad50c.png alt=image>、</p><p>These files are called SST files. For all the keys inside an SST file, they are well sorted by key, structured, and indexed. For Level 1 to Level 6, in every level, SST files are also sorted arranged. But two files in different levels may overlap. So do the files in Level 0, which are flushed and generated from memory (MemTable), i.e. files in L0 will overlap with each other. As shown in the following figure:</p><p><img src=https://user-images.githubusercontent.com/38887077/77512933-f01cb700-6eae-11ea-8bf1-822c7321a10c.png alt=image></p><h3 id=rocksdb-compaction>RocksDB  compaction</h3><p>RocksDB is based on  log-structured-merge tree (LSM tree). But LSM is a concept and design idea of data structure. Please refer to the <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.44.2782&rep=rep1&type=pdf">LSM thesis</a> for details. The most important part of LSM is compaction. Because data files are written in an append only mode, the expired, duplicated and removed data need to be cleaned up through a background compaction operation.</p><h3 id=rocksdb-compaction-logic>RocksDB compaction logic</h3><p>The compaction strategy used here is  leveled compaction (which is inspired by Google&rsquo;s famous LevelDB). When data is written to RocksDB, it is first written to a MemTable. When a MemTable is full, it will become an Immutable MemTable. RocksDB flushes this Immutable MemTable to disk through a flush thread in the background, generates a Sorted String Table (SST) file, and places it on Level 0. When the number of SST files in the Level 0 exceeds some threshold, a compaction is performed. It reads all the keys from Level 0, and writes some new SST files to the Level 1 layer. Generally, all files of L0 must be merged into L1 to improve read performance, because L0 files are usually overlapping.</p><p>Level 0 and Level 1 compactions are as follows:</p><p><img src=https://user-images.githubusercontent.com/38887077/77512941-f27f1100-6eae-11ea-92a9-6ee250004374.png alt=image></p><p>The compaction rules of other levels are the same, take the compaction of Level 1 and Level 2 as an example:</p><p><img src=https://user-images.githubusercontent.com/38887077/77512945-f448d480-6eae-11ea-9319-ed916e6a77cf.png alt=image></p><p>When a Level 0 compaction is completed, the total file size or number of files in Level 1 may exceed a threshold, triggering another compaction between Level 1 and Level 2. At least one file from L1 will be selected and some files in L2 are also selected (which have overlap with this selected L1 file). After this new compaction, the selected files in L1 and L2 are deleted from disk directly, and some new files will be written into L3, which  may again trigger another new compaction between L2 and L3, and so on.</p><p>From the user&rsquo;s view, if there is no compaction,  the write will be very fast (append only), but the read is very slow (the system has to find a key from a bunch of files). In order to make a balance among write, read, and disk usage, RocksDB performs compaction in the background to merge the SSTs of different levels.</p><h3 id=nebula-ttl-compactionprinciple>Nebula TTL compaction principle</h3><p>In addition to the above-mentioned default compaction operation (leveled SST file merge), RocksDB also provides a way to delete or modify key/value pairs based on custom logic in the background, i.e. the CompactionFilter.</p><p>Nebula Graph uses CompactionFilter to customize its own TTL function discussed in this post. The CompactionFilter calls a customized filter function each time when data is read in the compaction process. Based on the method, TTL compaction implements the TTLed data deletion logic in the filter function.</p><p>Following is the implementation in detail:</p><ol><li>First get the TTL information of tag/edge from meta service.</li><li>During graphs traverse, read a vertex or edge and take the value.</li><li>Get the sum of ttl_duration and ttl_col, then compare it with the current time. This determines whether the data is out of date. The expired data will be deleted.</li></ol><h2 id=ttl-in-practice>TTL in Practice</h2><p>In Nebula Graph, adding TTL to an edge is almost the same as to a tag. We take tag as an example to introduce the TTL usage.</p><h3 id=setting-a-ttl-value>Setting a TTL value</h3><p>There are two ways to set TTL value in Nebula Graph.</p><p>Set the TTL attribute when creating a new tag. Use ttl_col to indicate the TTL column, while ttl_duration indicates the lifespan of this tag.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; CREATE TAG t <span style=color:#f92672>(</span>id int, ts timestamp <span style=color:#f92672>)</span> ttl_duration <span style=color:#f92672>=</span> 3600, ttl_col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ts&#34;</span>;
</code></pre></div><p>When the sum of TTL column and ttl_duration is less than the current time, we consider the data as expired. The ttl_col data type must be integer or timestamp, and is set in seconds. ttl_duration is also set in seconds.</p><ul><li>When ttl_duration is set to -1 or 0, the vertex properties of this tag does not expire.</li><li>The ttl_col data type must be integer or timestamp.</li></ul><p>Or you can set a TTL value for an existing tag by an ALTER syntax.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; CREATE TAG t <span style=color:#f92672>(</span>id int, ts timestamp <span style=color:#f92672>)</span>;
nebula&gt; ALTER TAG t ttl_duration <span style=color:#f92672>=</span> 3600, ttl_col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ts&#34;</span>;
</code></pre></div><h3 id=show-ttl>Show TTL</h3><p>You can use the follow syntax to show your TTL values:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; SHOW CREATE TAG t;
<span style=color:#f92672>=====================================</span>
| Tag | Create Tag                  |
<span style=color:#f92672>=====================================</span>
| t   | CREATE TAG t <span style=color:#f92672>(</span>
  id int,
  ts timestamp
<span style=color:#f92672>)</span> ttl_duration <span style=color:#f92672>=</span> 3600, ttl_col <span style=color:#f92672>=</span> id |
-------------------------------------
</code></pre></div><h3 id=alter-ttl>Alter TTL</h3><p>Alter the TTL value with the <code>ALTER TAG</code> statement.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; ALTER TAG t ttl_duration <span style=color:#f92672>=</span> 100, ttl_col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>;
</code></pre></div><h3 id=drop-ttl>Drop TTL</h3><p>If you have set a TTL value for a field and later decided that you do not want it to ever automatically expire, you can drop the TTL value, set it to an empty string or invalidate it by setting it to 0 or -1.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; ALTER TAG t1 ttl_col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>; -- drop ttl attribute
</code></pre></div><p>Drop the <code>ttl_col</code> field:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; ALTER TAG t1 DROP <span style=color:#f92672>(</span>a<span style=color:#f92672>)</span>; -- drop ttl_col
</code></pre></div><p>Set ttl_duration to 0 or -1:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; ALTER TAG t1 ttl_duration <span style=color:#f92672>=</span> 0; -- keep the ttl but the data never expires
</code></pre></div><h3 id=example>Example</h3><p>The following example shows that when the TTL value is set and the data expires, the expired data is ignored by the system.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nebula&gt; CREATE TAG t<span style=color:#f92672>(</span>id int<span style=color:#f92672>)</span> ttl_duration <span style=color:#f92672>=</span> 100, ttl_col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>;
nebula&gt; INSERT VERTEX t<span style=color:#f92672>(</span>id<span style=color:#f92672>)</span> values 102:<span style=color:#f92672>(</span>1584441231<span style=color:#f92672>)</span>;

nebula&gt; FETCH prop on t 102;
Execution succeeded <span style=color:#f92672>(</span>Time spent: 5.945/7.492 ms<span style=color:#f92672>)</span>
</code></pre></div><p>NOTE:</p><ol><li>If a field contains a ttl_col value, you can&rsquo;t make any changes to the field.
You must drop the TTL value first, then alter the field.</li><li>Note that a tag or an edge cannot have both the TTL attribute and index at the same time, even if the ttl_col column is different from that of the index.</li></ol><p>Here comes to the end of the TTL introduction. Share your thought on TTL by raising us an <a href=https://github.com/vesoft-inc/nebula>issue</a> or post your feedback on our official <a href=https://discuss.nebula-graph.io/>forum</a>.</p><h2 id=you-might-also-like>You might also like</h2><ol><li><a href=https://nebula-graph.io/en/posts/how-indexing-works-in-nebula-graph/>How Indexing Works in Nebula Graph</a></li><li><a href=https://nebula-graph.io/en/posts/nebula-graph-storage-banlancing-data-migration/>Storage Balance and Data Migration</a></li><li><a href=https://nebula-graph.io/en/posts/nebula-graph-snapshot-introduction/>An Introduction to Snapshot in Nebula Graph</a></li></ol><blockquote class=star-ads><span>Like what we do ? Star us on GitHub.</span>
<a href=https://github.com/vesoft-inc/nebula>https://github.com/vesoft-inc/nebula</a></blockquote><ul class=blog-footer><li><img src=/images/tag.png>
<a href=/nebula-website/en/tags/features>features</a></li><li class="nebula-share st-btn"><img src=/images/share.png>
<span>Share Post</span><ul class=blog-footer-share-links><li class=st-custom-button data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg>
<span class=st-label>Twitter</span></li><li class=st-custom-button data-network=linkedin><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/linkedin-white.svg>
<span class=st-label>Linkedin</span></li><li class=st-custom-button data-network=facebook><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/facebook-white.svg>
<span class=st-label>Facebook</span></li><li class=st-custom-button data-network=sharethis><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg>
<span class=st-label>Others</span></li></ul></li><li onclick="location.href='\/nebula-website\/en\/posts'"><img src=/images/blog.png>
<a href=/nebula-website/en/posts>Back to blog home</a></li><li onclick="location.href='https:\/\/nebula-graph.io/en/posts/index.xml'"><img src=/images/rss.png>
<a onclick="window.open('https:\/\/nebula-graph.io/en/posts/index.xml')" href>RSS</a></li></ul><div id=discourse-comments></div></section><div class=single-side-bar><div class=tags-block><h3><img src=/img/LabelTagIcon.png>Tags</h3><ul class=blog-tags><li class=col-md-12><a href=/nebula-website/en/posts class=active>all</a></li><li><a href=/nebula-website/en/tags/architecture>architecture</a></li><li><a href=/nebula-website/en/tags/community>community</a></li><li><a href=/nebula-website/en/tags/deployment>deployment</a></li><li><a href=/nebula-website/en/tags/dev-log>dev-log</a></li><li><a href=/nebula-website/en/tags/features class=active>features</a></li><li><a href=/nebula-website/en/tags/graph-database>graph-database</a></li><li><a href=/nebula-website/en/tags/performance>performance</a></li><li><a href=/nebula-website/en/tags/query-language>query-language</a></li><li><a href=/nebula-website/en/tags/release-notes>release-Notes</a></li><li><a href=/nebula-website/en/tags/system-testing>system-testing</a></li><li><a href=/nebula-website/en/tags/tools>tools</a></li><li><a href=/nebula-website/en/tags/use-cases>use-cases</a></li></ul></div><div class=blog-anchors><h3>Contents</h3><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#stored-procedures-and-events>Stored Procedures and Events</a><ul><li><a href=#stored-procedures>Stored Procedures</a></li><li><a href=#events>Events</a></li></ul></li><li><a href=#cleaning-data-via-ttl>Cleaning Data via TTL</a></li><li><a href=#introduction-to-ttl>Introduction to TTL</a></li><li><a href=#ttl-read-filtering>TTL Read Filtering</a></li><li><a href=#ttl-compaction-details>TTL Compaction Details</a><ul><li><a href=#background-rocksdb-file-organizations>Background: RocksDB file organizations</a></li><li><a href=#rocksdb-compaction>RocksDB  compaction</a></li><li><a href=#rocksdb-compaction-logic>RocksDB compaction logic</a></li><li><a href=#nebula-ttl-compactionprinciple>Nebula TTL compaction principle</a></li></ul></li><li><a href=#ttl-in-practice>TTL in Practice</a><ul><li><a href=#setting-a-ttl-value>Setting a TTL value</a></li><li><a href=#show-ttl>Show TTL</a></li><li><a href=#alter-ttl>Alter TTL</a></li><li><a href=#drop-ttl>Drop TTL</a></li><li><a href=#example>Example</a></li></ul></li><li><a href=#you-might-also-like>You might also like</a></li></ul></nav></div><div class=social-share><h3>Share Post</h3><div class=nebula-share-buttons><div class="st-custom-button st-remove-label" data-network=twitter><img alt="twitter-white sharing button" src=https://platform-cdn.sharethis.com/img/twitter-white.svg></div><div class="st-custom-button st-remove-label" data-network=linkedin><img alt="linkedin-white sharing button" src=https://platform-cdn.sharethis.com/img/linkedin-white.svg></div><div class="st-custom-button st-remove-label" data-network=facebook><img alt="facebook-white sharing button" src=https://platform-cdn.sharethis.com/img/facebook-white.svg></div><div class="st-custom-button st-remove-label" data-network=hackernews><img alt="hackernews-white sharing button" src=https://platform-cdn.sharethis.com/img/hackernews-white.svg></div><div class="st-custom-button st-remove-label" data-network=reddit><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/reddit-white.svg></div><div class="st-custom-button st-remove-label" data-network=sharethis><img alt="reddit-white sharing button" src=https://platform-cdn.sharethis.com/img/sharethis-white.svg></div></div></div></div></div><img onclick="location.href='#top'" class=go-ahead src=/images/up.png></div><footer class="container-fluid foot-wrap" name=contact_us><div class=container><div class=row><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Community</h3><ul><li><img src=/img/github.png>
<a href=https://github.com/vesoft-inc/nebula target=_blank>GitHub</a></li><li><img src=/img/forum.png>
<a href=https://discuss.nebula-graph.io/ target=_blank>Forum</a></li><li><img src=/img/slack.png>
<a href=https://join.slack.com/t/nebulagraph/shared_invite/enQtNjIzMjQ5MzE2OTQ2LTM0MjY0MWFlODg3ZTNjMjg3YWU5ZGY2NDM5MDhmOGU2OWI5ZWZjZDUwNTExMGIxZTk2ZmQxY2Q2MzM1OWJhMmY# target=_blank>Slack</a></li></ul></div><div class="row-content col-lg-4 col-sm-4 col-xs-4"><h3>Follow Us</h3><ul><li><img src=/img/twitter.png>
<a href=https://twitter.com/NebulaGraph title=Twitter data-toggle=modal target=_blank data-target>Twitter</a></li><li><img src=/img/linkedin.png>
<a href=https://www.linkedin.com/company/vesoft-nebula-graph/ title=LinkedIn data-toggle=modal target=_blank data-target>LinkedIn</a></li><li><img src=/img/youtube.png>
<a href=https://www.youtube.com/channel/UC73V8q795eSEMxDX4Pvdwmw title=YouTube data-toggle=modal target=_blank data-target>YouTube</a></li><li><img src=/img/facebook.png>
<a href=https://www.facebook.com/NebulaGraph/ title=FaceBook data-toggle=modal target=_blank data-target>FaceBook</a></li><li><img src=/img/weibo.png>
<a href=https://weibo.com/nebulagraph title=WeiBo data-toggle=modal target=_blank data-target>WeiBo</a></li><li><img src=/img/gongzhonghao.png>
<a href title="Official Accounts" data-toggle=modal target=_blank data-target=#myGongzhonghaoModal>Official Accounts</a></li></ul></div><div class="contactus row-content col-lg-4 col-sm-4 col-xs-4"><h3>Contact Us</h3><ul><li><img src=/img/iphone.png>
<a href data-toggle=modal target=_blank data-target>(+86) 0571-28120658</a></li><li><img src=/img/email.png>
<a href=mailto:info@vesoft.com data-toggle=modal target=_blank data-target>info@vesoft.com</a></li><li><img src=/img/weixin.png>
<a href data-toggle=modal target=_blank data-target=#myModal>WeChat</a></li></ul></div></div></div><p align=left style=font-size:16px><img src=/images/VEsoft.png style=margin-right:10px> Copyright &copy;2020 VESoft Inc</p><div class="modal fade" id=myGongzhonghaoModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/gonggonghaoCODE.jpg></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div><div class="modal fade" id=myModal tabindex=-1 role=dialog aria-labelledby=myModalLabel aria-hidden=true><div class=modal-dialog><div class=modal-content><div class="modal-body wechat"><img src=/images/wechat.png></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>close</button></div></div></div></div></footer></main><div id=J-star-popup class=nebula-star-popup></div><script src=/nebula-website/js/jquery.js></script><script src=/nebula-website/js/bootstrap.min.js></script><script src=/nebula-website/js/jquery.easing.min.js></script><script src=/nebula-website/js/jquery.fittext.js></script><script src=/nebula-website/js/wow.min.js></script><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=5e7c2cc315c7990012ae38bc&product=inline-share-buttons" async></script><script src=/nebula-website/js/creative.js></script><script async defer src=https://buttons.github.io/buttons.js></script><script src=/nebula-website/js/init.js></script><script type=text/javascript>DiscourseEmbed={discourseUrl:'https://discuss.nebula-graph.io/',discourseEmbedUrl:"\/nebula-website\/en\/posts\/clean-stale-data-with-ttl-in-nebula-graph\/"};(function(){var d=document.createElement('script');d.type='text/javascript';d.async=true;d.src=DiscourseEmbed.discourseUrl+'javascripts/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(d);})();</script></body></html><script>if(!sessionStorage.getItem("popupIsRemove")){$("#top").css("padding-top","98px")}</script>